"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.AGSSharedInfraClient = void 0;
const aws_ec2_1 = require("aws-cdk-lib/aws-ec2");
const ssm = require("aws-cdk-lib/aws-ssm");
const constructs_1 = require("constructs");
// SSM Parameter Names
const SSM_DEPLOYMENT_OPTIONS = '/ags/deploymentOptions';
const SSM_VPC_ID = '/ags/vpcId';
const SSM_VPC_ENDPOINT_ID = '/ags/apigatewayVpcEndpointId';
const SSM_PERMISSION_BOUNDARY_POLICY_ARN = '/ags/permissionBoundaryPolicyArn';
const SSM_WEB_DIST_ID = '/ags/webClientDistributionId';
const SSM_SUBNET_MAPPING = '/ags/subnetmapping';
const SSM_ES_SERVICE_LINKED_ROLE_AVILABLE = '/ags/elasticSearchServiceLinkedRoleAvailable';
const SSM_CUSTOM_API_RESOURCE_POLICY = '/ags/customAPIResourcePolicyJSON';
const SSM_API_WEB_ACL_ARN = '/ags/apigatewayWebAclArn';
class AGSSharedInfraClient extends constructs_1.Construct {
    constructor(scope, id) {
        super(scope, id);
        this.deploymentOptions = this.readJSONParameter(SSM_DEPLOYMENT_OPTIONS, {
            apiGatewayType: 'private',
            bastionInstance: false,
            developmentUserRole: true,
            trustedDeveloperAccounts: '',
        });
        this.trustedDeveloperAccounts = (this.deploymentOptions.trustedDeveloperAccounts || '').split(',');
        this.customAPIResourcePolicyJSON = this.readStringParameter(SSM_CUSTOM_API_RESOURCE_POLICY, 'NONE');
        // lookup vpc
        const vpcId = ssm.StringParameter.valueFromLookup(this, SSM_VPC_ID);
        this.vpc = aws_ec2_1.Vpc.fromLookup(this, 'vpc', {
            vpcId,
        });
        // look up apigatewayVpcEndpointId only when APIGateway is in private setting
        if (this.deploymentOptions.apiGatewayType === 'private') {
            const vpcEndpointId = ssm.StringParameter.valueFromLookup(this, SSM_VPC_ENDPOINT_ID);
            this.apigatewayVpcEndpoint =
                aws_ec2_1.InterfaceVpcEndpoint.fromInterfaceVpcEndpointAttributes(this, 'apigatewayVpcEndpoint', {
                    vpcEndpointId,
                    port: 443,
                });
        }
        // look up permission boundary policy arn from shared infra
        const policyArn = ssm.StringParameter.valueFromLookup(this, SSM_PERMISSION_BOUNDARY_POLICY_ARN);
        this.permissionBoundaryPolicyArn = /arn:aws:iam::[0-9]+:policy\/.+/.test(policyArn)
            ? policyArn
            : '';
        // look up web distribution id
        this.webDistributionId = ssm.StringParameter.valueFromLookup(this, SSM_WEB_DIST_ID);
        // look up subnet mapping
        const subnetMappingOptions = this.readJSONParameter(SSM_SUBNET_MAPPING, {
            ingress: {
                subnetGroupName: 'ingress',
                securityGroupIds: [],
            },
            service: {
                subnetGroupName: 'service',
                securityGroupIds: [],
            },
            database: {
                subnetGroupName: 'database',
                securityGroupIds: [],
            },
        });
        this.subnetMapping = {
            ingress: this.getSubnetSecurityGroupMapping(subnetMappingOptions.ingress),
            service: this.getSubnetSecurityGroupMapping(subnetMappingOptions.service),
            database: this.getSubnetSecurityGroupMapping(subnetMappingOptions.database),
        };
        const esServiceLinkedRoleFlag = ssm.StringParameter.valueFromLookup(this, SSM_ES_SERVICE_LINKED_ROLE_AVILABLE);
        this.elasticSearchServiceLinkedRoleAvailable =
            esServiceLinkedRoleFlag.toLowerCase() === 'true';
        this.apiGatewayWebAclArn = ssm.StringParameter.valueFromLookup(this, SSM_API_WEB_ACL_ARN);
    }
    getSubnetSecurityGroupMapping(mapping) {
        return {
            subnetGroupName: mapping.subnetGroupName,
            securityGroups: mapping.securityGroupIds.length > 0
                ? mapping.securityGroupIds.map((id) => aws_ec2_1.SecurityGroup.fromSecurityGroupId(this, `sg-${id}`, id, {
                    allowAllOutbound: false,
                    mutable: false,
                }))
                : undefined,
        };
    }
    getSubnetsByGroupName(subnetGroupName) {
        return {
            subnetGroupName: this.subnetMapping[subnetGroupName].subnetGroupName,
        };
    }
    getSubnetSecurityGroups(subnetGroupName) {
        return this.subnetMapping[subnetGroupName].securityGroups;
    }
    /**
     * Read JSON string stored in SSM ParameterStore and return object
     *
     * This function returns a default value if the value returned from `ssm.StringParameter.valueFromLookup` is an token
     * so that the synth process can continue. It happens when cdk doesn't have this ssm parameter cached in cdk.context.json
     *
     * During cdk synth time, SSM parameter values could be resolved into token first
     * before the real string value is fetched from the server. Once the value is fetched
     * it will be stored in cdk.context.json.
     *
     * CDK will run the same stack a few passes during the synth. The token will only
     * be resolved in the real string in the later passes but not the first pass.
     *
     * If the SSM parameter value need to be parsed and used in the stack code, the
     * stack code will only get the token in first pass and will fail and thus
     * prevent the stack synth to be completed.
     *
     * The workaround is to run cdk synth twice, with refreshContext flag in the
     * first time. When this flag is set, the stack should run some special code
     * which only retrieve SSM parameters. This will force cdk to retrieve it from
     * the environment and store it in cdk.context.json. The stack code should not
     * parse or interprete the value.
    
     * After the first synth completed (with only the SSM parameters in the stack),
     * run cdk synth again without setting this flag (refreshContext). The second
     * cdk synth will read the SSM parameter values from cdk.context.json and will pass.
     *
     * @param parameterName Name of the SSM parameter
     * @param defaultValue The default value of this SSM parameter if the value is not retrieve yet.
     * @returns JSON Object that stored in this SSM paramter or the default value
     */
    readJSONParameter(parameterName, defaultValue) {
        const value = ssm.StringParameter.valueFromLookup(this, parameterName);
        if (value === `dummy-value-for-${parameterName}`) {
            return defaultValue;
        }
        else {
            return JSON.parse(value);
        }
    }
    readStringParameter(parameterName, defaultValue) {
        const value = ssm.StringParameter.valueFromLookup(this, parameterName);
        if (value === `dummy-value-for-${parameterName}`) {
            return defaultValue;
        }
        else {
            return value;
        }
    }
}
exports.AGSSharedInfraClient = AGSSharedInfraClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWdzLXNoYXJlZC1pbmZyYS1jbGllbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9saWIvYWdzLXNoYXJlZC1pbmZyYS1jbGllbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBZ0JBLGlEQVE2QjtBQUM3QiwyQ0FBMkM7QUFDM0MsMkNBQXVDO0FBUXZDLHNCQUFzQjtBQUN0QixNQUFNLHNCQUFzQixHQUFHLHdCQUF3QixDQUFDO0FBQ3hELE1BQU0sVUFBVSxHQUFHLFlBQVksQ0FBQztBQUNoQyxNQUFNLG1CQUFtQixHQUFHLDhCQUE4QixDQUFDO0FBQzNELE1BQU0sa0NBQWtDLEdBQUcsa0NBQWtDLENBQUM7QUFDOUUsTUFBTSxlQUFlLEdBQUcsOEJBQThCLENBQUM7QUFDdkQsTUFBTSxrQkFBa0IsR0FBRyxvQkFBb0IsQ0FBQztBQUNoRCxNQUFNLG1DQUFtQyxHQUNyQyw4Q0FBOEMsQ0FBQztBQUNuRCxNQUFNLDhCQUE4QixHQUFHLGtDQUFrQyxDQUFDO0FBQzFFLE1BQU0sbUJBQW1CLEdBQUcsMEJBQTBCLENBQUM7QUFFdkQsTUFBYSxvQkFBcUIsU0FBUSxzQkFBUztJQWlFL0MsWUFBWSxLQUFnQixFQUFFLEVBQVU7UUFDcEMsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQixJQUFJLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLHNCQUFzQixFQUFFO1lBQ3BFLGNBQWMsRUFBRSxTQUFTO1lBQ3pCLGVBQWUsRUFBRSxLQUFLO1lBQ3RCLG1CQUFtQixFQUFFLElBQUk7WUFDekIsd0JBQXdCLEVBQUUsRUFBRTtTQUMvQixDQUFDLENBQUM7UUFDSCxJQUFJLENBQUMsd0JBQXdCLEdBQUcsQ0FDNUIsSUFBSSxDQUFDLGlCQUFpQixDQUFDLHdCQUF3QixJQUFJLEVBQUUsQ0FDeEQsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFYixJQUFJLENBQUMsMkJBQTJCLEdBQUcs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RCxnQkFBZ0IsRUFBRSxLQUFLO29CQUN2QixPQUFPLEVBQUUsS0FBSztpQkFDakIsQ0FBQyxDQUNMO2dCQUNILENBQUMsQ0FBQyxTQUFTO1NBQ3RCLENBQUM7SUFDTixDQUFDO0lBRUQscUJBQXFCLENBQUMsZUFBNEI7UUFDOUMsT0FBTztZQUNILGVBQWUsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLGVBQWUsQ0FBQyxDQUFDLGVBQWU7U0FDdkUsQ0FBQztJQUNOLENBQUM7SUFFRCx1QkFBdUIsQ0FBQyxlQUE0QjtRQUNoRCxPQUFPLElBQUksQ0FBQyxhQUFhLENBQUMsZUFBZSxDQUFDLENBQUMsY0FBYyxDQUFDO0lBQzlELENBQUM7SUFFRDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O09BOEJHO0lBQ0gsaUJBQWlCLENBQUksYUFBcUIsRUFBRSxZQUFlO1FBQ3ZELE1BQU0sS0FBSyxHQUFHLEdBQUcsQ0FBQyxlQUFlLENBQUMsZUFBZSxDQUFDLElBQUksRUFBRSxhQUFhLENBQUMsQ0FBQztRQUN2RSxJQUFJLEtBQUssS0FBSyxtQkFBbUIsYUFBYSxFQUFFLEVBQUU7WUFDOUMsT0FBTyxZQUFZLENBQUM7U0FDdkI7YUFBTTtZQUNILE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUM1QjtJQUNMLENBQUM7SUFFRCxtQkFBbUIsQ0FBQyxhQUFxQixFQUFFLFlBQW9CO1FBQzNELE1BQU0sS0FBSyxHQUFHLEdBQUcsQ0FBQyxlQUFlLENBQUMsZUFBZSxDQUFDLElBQUksRUFBRSxhQUFhLENBQUMsQ0FBQztRQUN2RSxJQUFJLEtBQUssS0FBSyxtQkFBbUIsYUFBYSxFQUFFLEVBQUU7WUFDOUMsT0FBTyxZQUFZLENBQUM7U0FDdkI7YUFBTTtZQUNILE9BQU8sS0FBSyxDQUFDO1NBQ2hCO0lBQ0wsQ0FBQztDQUNKO0FBOU9ELG9EQThPQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIFxuICBDb3B5cmlnaHQgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAgXG4gIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIikuXG4gIFlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gIFxuICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gIFxuICBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuaW1wb3J0ICogYXMgY2RrIGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCB7XG4gICAgSVZwYyxcbiAgICBWcGMsXG4gICAgSUludGVyZmFjZVZwY0VuZHBvaW50LFxuICAgIEludGVyZmFjZVZwY0VuZHBvaW50LFxuICAgIFN1Ym5ldFNlbGVjdGlvbixcbiAgICBJU2VjdXJpdHlHcm91cCxcbiAgICBTZWN1cml0eUdyb3VwLFxufSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZWMyJztcbmltcG9ydCAqIGFzIHNzbSBmcm9tICdhd3MtY2RrLWxpYi9hd3Mtc3NtJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHtcbiAgICBEZXBsb3ltZW50T3B0aW9ucyxcbiAgICBTdWJuZXRHcm91cCxcbiAgICBTdWJuZXRNYXBwaW5nLFxuICAgIFN1Ym5ldE1hcHBpbmdPcHRpb25zLFxufSBmcm9tICcuL2Fncy10eXBlcyc7XG5cbi8vIFNTTSBQYXJhbWV0ZXIgTmFtZXNcbmNvbnN0IFNTTV9ERVBMT1lNRU5UX09QVElPTlMgPSAnL2Fncy9kZXBsb3ltZW50T3B0aW9ucyc7XG5jb25zdCBTU01fVlBDX0lEID0gJy9hZ3MvdnBjSWQnO1xuY29uc3QgU1NNX1ZQQ19FTkRQT0lOVF9JRCA9ICcvYWdzL2FwaWdhdGV3YXlWcGNFbmRwb2ludElkJztcbmNvbnN0IFNTTV9QRVJNSVNTSU9OX0JPVU5EQVJZX1BPTElDWV9BUk4gPSAnL2Fncy9wZXJtaXNzaW9uQm91bmRhcnlQb2xpY3lBcm4nO1xuY29uc3QgU1NNX1dFQl9ESVNUX0lEID0gJy9hZ3Mvd2ViQ2xpZW50RGlzdHJpYnV0aW9uSWQnO1xuY29uc3QgU1NNX1NVQk5FVF9NQVBQSU5HID0gJy9hZ3Mvc3VibmV0bWFwcGluZyc7XG5jb25zdCBTU01fRVNfU0VSVklDRV9MSU5LRURfUk9MRV9BVklMQUJMRSA9XG4gICAgJy9hZ3MvZWxhc3RpY1NlYXJjaFNlcnZpY2VMaW5rZWRSb2xlQXZhaWxhYmxlJztcbmNvbnN0IFNTTV9DVVNUT01fQVBJX1JFU09VUkNFX1BPTElDWSA9ICcvYWdzL2N1c3RvbUFQSVJlc291cmNlUG9saWN5SlNPTic7XG5jb25zdCBTU01fQVBJX1dFQl9BQ0xfQVJOID0gJy9hZ3MvYXBpZ2F0ZXdheVdlYkFjbEFybic7XG5cbmV4cG9ydCBjbGFzcyBBR1NTaGFyZWRJbmZyYUNsaWVudCBleHRlbmRzIENvbnN0cnVjdCB7XG4gICAgLy8gc2hhcmVkIGluZnJhIGNvbnRleHRcbiAgICAvKipcbiAgICAgKiBOYW1lIG9mIHRoZSBjb25maWd1cmF0aW9uIGRlcGxveWVkIGJ5IHRoZSBTaGFyZWQgSW5mcmEgaW4gdGhlIHRhcmdldCBlbnZpcm9ubWVudC5cbiAgICAgKlxuICAgICAqL1xuICAgIHB1YmxpYyByZWFkb25seSBjb25maWdOYW1lOiBzdHJpbmc7XG4gICAgLyoqXG4gICAgICogRGVwbG95bWVudCBvcHRpb25zIG9mIHRoZSBTaGFyZWQgSW5mcmEgaW4gdGhlIHRhcmdldCBlbnZpcm9ubWVudC5cbiAgICAgKlxuICAgICAqL1xuICAgIHB1YmxpYyByZWFkb25seSBkZXBsb3ltZW50T3B0aW9uczogRGVwbG95bWVudE9wdGlvbnM7XG4gICAgLyoqXG4gICAgICogQSBsaXN0IG9mIHRoZSBBV1MgYWNjb3VudCBJRHMgb2YgdGhlIHRydXN0ZWQgZGV2ZWxvcG1lbnQgYWNjb3VudHMuXG4gICAgICpcbiAgICAgKiBTZXJ2aWNlcyBkZXZlcGxveWVkIGluIGFueSBhY2NvdW50IGluIHRoZSBsaXN0IHdpbGwgYmUgYWJsZSB0byBjYWxsIEFQSXMgaW4gdGhlIHRlYW0gc2hhcmVkIGFjY291bnRcbiAgICAgKi9cbiAgICBwdWJsaWMgcmVhZG9ubHkgdHJ1c3RlZERldmVsb3BlckFjY291bnRzOiBzdHJpbmdbXTtcbiAgICAvKipcbiAgICAgKiBWUEMgaW4gdGhlIFNoYXJlZCBJbmZyYSBpbiB0aGUgdGFyZ2V0IGVudmlyb25tZW50LlxuICAgICAqXG4gICAgICovXG4gICAgcHVibGljIHJlYWRvbmx5IHZwYzogSVZwYztcbiAgICAvKipcbiAgICAgKiBJbnRlcmZhY2VWUENFbmRwb2ludCBpbiB0aGUgU2hhcmVkIEluZnJhIGluIHRoZSB0YXJnZXQgZW52aXJvbm1lbnQuXG4gICAgICpcbiAgICAgKiBUaGUgSW50ZXJmYWNlVlBDRW5kcG9pbnQgaXMgb25seSBhdmFpbGFibGUgd2hlbiBhcGlHYXRld2F5VHlwZSBpblxuICAgICAqIGRlcGxveW1lbnRPcHRpb25zIGlzIHNldCB0byBgcHJpdmF0ZWAuXG4gICAgICogV2hlbiBhcGlHYXRld2F5VHlwZSBpcyBzZXQgdG8gYHB1YmxpY2Agb3IgYGNsb3VkZnJvbnRgLCB0aGlzIHZhdWxlIGlzIHVuZGVmaW5lZFxuICAgICAqL1xuICAgIHB1YmxpYyByZWFkb25seSBhcGlnYXRld2F5VnBjRW5kcG9pbnQ6IElJbnRlcmZhY2VWcGNFbmRwb2ludDtcbiAgICAvKipcbiAgICAgKiBDbG91ZEZyb250IGRpc3RyaWJ1dGlvbiBJRCBmb3IgV2ViIENsaWVudCBkZXBsb3llZCBieSBTaGFyZWQgSW5mcmEgaW4gdGhlIHRhcmdldCBhY2NvdW50XG4gICAgICpcbiAgICAgKi9cbiAgICBwdWJsaWMgcmVhZG9ubHkgd2ViRGlzdHJpYnV0aW9uSWQ6IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIE1hbmFnZWQgcGVybWlzc2lvbiBib3VuZGFyeSBwb2xpY3kgQVJOXG4gICAgICpcbiAgICAgKi9cbiAgICBwdWJsaWMgcmVhZG9ubHkgcGVybWlzc2lvbkJvdW5kYXJ5UG9saWN5QXJuOiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBGbGFnIGluZGljYXRpbmcgd2hldGhlciBhIHNlcnZpY2UgbGlua2VkIHJvbGUgZm9yIEVsYXN0aWNTZWFyY2ggaXMgYXZhaWxhYmxlIGluIHRoZSB0YXJnZXQgZW52aXJvbm1lbnQuXG4gICAgICovXG4gICAgcHVibGljIHJlYWRvbmx5IGVsYXN0aWNTZWFyY2hTZXJ2aWNlTGlua2VkUm9sZUF2YWlsYWJsZTogYm9vbGVhbjtcblxuICAgIC8qKlxuICAgICAqIEpTT04gVGV4dCBmb3IgYWRkaXRvbmFsIGN1c3RvbSBBUElHYXRld2F5IHJlc291cmNlIHBvbGljeS4gU2V0IHRvIE5PTkUgdG8gaW5kaWNhdGUgdGhlcmUgaXMgbm8gY3VzdG9tIEFQSSByZXNvdXJjZSBwb2xpY3lcbiAgICAgKi9cbiAgICBwdWJsaWMgcmVhZG9ubHkgY3VzdG9tQVBJUmVzb3VyY2VQb2xpY3lKU09OOiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBBUk4gb2YgV0FGIFdlYiBBQ0wgZm9yIEFQSUdhdGV3YXkgQVBJc1xuICAgICAqL1xuICAgIHB1YmxpYyByZWFkb25seSBhcGlHYXRld2F5V2ViQWNsQXJuOiBzdHJpbmc7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IHN1Ym5ldE1hcHBpbmc6IHtcbiAgICAgICAgW2tleSBpbiBTdWJuZXRHcm91cF06IHtcbiAgICAgICAgICAgIHN1Ym5ldEdyb3VwTmFtZTogc3RyaW5nO1xuICAgICAgICAgICAgc2VjdXJpdHlHcm91cHM6IElTZWN1cml0eUdyb3VwW10gfCB1bmRlZmluZWQ7XG4gICAgICAgIH07XG4gICAgfTtcblxuICAgIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcpIHtcbiAgICAgICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgICAgICB0aGlzLmRlcGxveW1lbnRPcHRpb25zID0gdGhpcy5yZWFkSlNPTlBhcmFtZXRlcihTU01fREVQTE9ZTUVOVF9PUFRJT05TLCB7XG4gICAgICAgICAgICBhcGlHYXRld2F5VHlwZTogJ3ByaXZhdGUnLFxuICAgICAgICAgICAgYmFzdGlvbkluc3RhbmNlOiBmYWxzZSxcbiAgICAgICAgICAgIGRldmVsb3BtZW50VXNlclJvbGU6IHRydWUsXG4gICAgICAgICAgICB0cnVzdGVkRGV2ZWxvcGVyQWNjb3VudHM6ICcnLFxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy50cnVzdGVkRGV2ZWxvcGVyQWNjb3VudHMgPSAoXG4gICAgICAgICAgICB0aGlzLmRlcGxveW1lbnRPcHRpb25zLnRydXN0ZWREZXZlbG9wZXJBY2NvdW50cyB8fCAnJ1xuICAgICAgICApLnNwbGl0KCcsJyk7XG5cbiAgICAgICAgdGhpcy5jdXN0b21BUElSZXNvdXJjZVBvbGljeUpTT04gPSB0aGlzLnJlYWRTdHJpbmdQYXJhbWV0ZXIoXG4gICAgICAgICAgICBTU01fQ1VTVE9NX0FQSV9SRVNPVVJDRV9QT0xJQ1ksXG4gICAgICAgICAgICAnTk9ORSdcbiAgICAgICAgKTtcblxuICAgICAgICAvLyBsb29rdXAgdnBjXG4gICAgICAgIGNvbnN0IHZwY0lkID0gc3NtLlN0cmluZ1BhcmFtZXRlci52YWx1ZUZyb21Mb29rdXAodGhpcywgU1NNX1ZQQ19JRCk7XG4gICAgICAgIHRoaXMudnBjID0gVnBjLmZyb21Mb29rdXAodGhpcywgJ3ZwYycsIHtcbiAgICAgICAgICAgIHZwY0lkLFxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBsb29rIHVwIGFwaWdhdGV3YXlWcGNFbmRwb2ludElkIG9ubHkgd2hlbiBBUElHYXRld2F5IGlzIGluIHByaXZhdGUgc2V0dGluZ1xuICAgICAgICBpZiAodGhpcy5kZXBsb3ltZW50T3B0aW9ucy5hcGlHYXRld2F5VHlwZSA9PT0gJ3ByaXZhdGUnKSB7XG4gICAgICAgICAgICBjb25zdCB2cGNFbmRwb2ludElkID0gc3NtLlN0cmluZ1BhcmFtZXRlci52YWx1ZUZyb21Mb29rdXAoXG4gICAgICAgICAgICAgICAgdGhpcyxcbiAgICAgICAgICAgICAgICBTU01fVlBDX0VORFBPSU5UX0lEXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgdGhpcy5hcGlnYXRld2F5VnBjRW5kcG9pbnQgPVxuICAgICAgICAgICAgICAgIEludGVyZmFjZVZwY0VuZHBvaW50LmZyb21JbnRlcmZhY2VWcGNFbmRwb2ludEF0dHJpYnV0ZXMoXG4gICAgICAgICAgICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgICAgICAgICAgICdhcGlnYXRld2F5VnBjRW5kcG9pbnQnLFxuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2cGNFbmRwb2ludElkLFxuICAgICAgICAgICAgICAgICAgICAgICAgcG9ydDogNDQzLFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGxvb2sgdXAgcGVybWlzc2lvbiBib3VuZGFyeSBwb2xpY3kgYXJuIGZyb20gc2hhcmVkIGluZnJhXG4gICAgICAgIGNvbnN0IHBvbGljeUFybiA9IHNzbS5TdHJpbmdQYXJhbWV0ZXIudmFsdWVGcm9tTG9va3VwKFxuICAgICAgICAgICAgdGhpcyxcbiAgICAgICAgICAgIFNTTV9QRVJNSVNTSU9OX0JPVU5EQVJZX1BPTElDWV9BUk5cbiAgICAgICAgKTtcblxuICAgICAgICB0aGlzLnBlcm1pc3Npb25Cb3VuZGFyeVBvbGljeUFybiA9IC9hcm46YXdzOmlhbTo6WzAtOV0rOnBvbGljeVxcLy4rLy50ZXN0KFxuICAgICAgICAgICAgcG9saWN5QXJuXG4gICAgICAgIClcbiAgICAgICAgICAgID8gcG9saWN5QXJuXG4gICAgICAgICAgICA6ICcnO1xuXG4gICAgICAgIC8vIGxvb2sgdXAgd2ViIGRpc3RyaWJ1dGlvbiBpZFxuICAgICAgICB0aGlzLndlYkRpc3RyaWJ1dGlvbklkID0gc3NtLlN0cmluZ1BhcmFtZXRlci52YWx1ZUZyb21Mb29rdXAoXG4gICAgICAgICAgICB0aGlzLFxuICAgICAgICAgICAgU1NNX1dFQl9ESVNUX0lEXG4gICAgICAgICk7XG5cbiAgICAgICAgLy8gbG9vayB1cCBzdWJuZXQgbWFwcGluZ1xuICAgICAgICBjb25zdCBzdWJuZXRNYXBwaW5nT3B0aW9ucyA9IHRoaXMucmVhZEpTT05QYXJhbWV0ZXI8U3VibmV0TWFwcGluZ09wdGlvbnM+KFxuICAgICAgICAgICAgU1NNX1NVQk5FVF9NQVBQSU5HLFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGluZ3Jlc3M6IHtcbiAgICAgICAgICAgICAgICAgICAgc3VibmV0R3JvdXBOYW1lOiAnaW5ncmVzcycsXG4gICAgICAgICAgICAgICAgICAgIHNlY3VyaXR5R3JvdXBJZHM6IFtdLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgc2VydmljZToge1xuICAgICAgICAgICAgICAgICAgICBzdWJuZXRHcm91cE5hbWU6ICdzZXJ2aWNlJyxcbiAgICAgICAgICAgICAgICAgICAgc2VjdXJpdHlHcm91cElkczogW10sXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBkYXRhYmFzZToge1xuICAgICAgICAgICAgICAgICAgICBzdWJuZXRHcm91cE5hbWU6ICdkYXRhYmFzZScsXG4gICAgICAgICAgICAgICAgICAgIHNlY3VyaXR5R3JvdXBJZHM6IFtdLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9XG4gICAgICAgICk7XG5cbiAgICAgICAgdGhpcy5zdWJuZXRNYXBwaW5nID0ge1xuICAgICAgICAgICAgaW5ncmVzczogdGhpcy5nZXRTdWJuZXRTZWN1cml0eUdyb3VwTWFwcGluZyhzdWJuZXRNYXBwaW5nT3B0aW9ucy5pbmdyZXNzKSxcbiAgICAgICAgICAgIHNlcnZpY2U6IHRoaXMuZ2V0U3VibmV0U2VjdXJpdHlHcm91cE1hcHBpbmcoc3VibmV0TWFwcGluZ09wdGlvbnMuc2VydmljZSksXG4gICAgICAgICAgICBkYXRhYmFzZTogdGhpcy5nZXRTdWJuZXRTZWN1cml0eUdyb3VwTWFwcGluZyhzdWJuZXRNYXBwaW5nT3B0aW9ucy5kYXRhYmFzZSksXG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3QgZXNTZXJ2aWNlTGlua2VkUm9sZUZsYWcgPSBzc20uU3RyaW5nUGFyYW1ldGVyLnZhbHVlRnJvbUxvb2t1cChcbiAgICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgICBTU01fRVNfU0VSVklDRV9MSU5LRURfUk9MRV9BVklMQUJMRVxuICAgICAgICApO1xuICAgICAgICB0aGlzLmVsYXN0aWNTZWFyY2hTZXJ2aWNlTGlua2VkUm9sZUF2YWlsYWJsZSA9XG4gICAgICAgICAgICBlc1NlcnZpY2VMaW5rZWRSb2xlRmxhZy50b0xvd2VyQ2FzZSgpID09PSAndHJ1ZSc7XG5cbiAgICAgICAgdGhpcy5hcGlHYXRld2F5V2ViQWNsQXJuID0gc3NtLlN0cmluZ1BhcmFtZXRlci52YWx1ZUZyb21Mb29rdXAoXG4gICAgICAgICAgICB0aGlzLFxuICAgICAgICAgICAgU1NNX0FQSV9XRUJfQUNMX0FSTlxuICAgICAgICApO1xuICAgIH1cblxuICAgIGdldFN1Ym5ldFNlY3VyaXR5R3JvdXBNYXBwaW5nKG1hcHBpbmc6IFN1Ym5ldE1hcHBpbmcpOiB7XG4gICAgICAgIHN1Ym5ldEdyb3VwTmFtZTogc3RyaW5nO1xuICAgICAgICBzZWN1cml0eUdyb3VwczogSVNlY3VyaXR5R3JvdXBbXSB8IHVuZGVmaW5lZDtcbiAgICB9IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHN1Ym5ldEdyb3VwTmFtZTogbWFwcGluZy5zdWJuZXRHcm91cE5hbWUsXG4gICAgICAgICAgICBzZWN1cml0eUdyb3VwczpcbiAgICAgICAgICAgICAgICBtYXBwaW5nLnNlY3VyaXR5R3JvdXBJZHMubGVuZ3RoID4gMFxuICAgICAgICAgICAgICAgICAgICA/IG1hcHBpbmcuc2VjdXJpdHlHcm91cElkcy5tYXAoKGlkKSA9PlxuICAgICAgICAgICAgICAgICAgICAgICAgICBTZWN1cml0eUdyb3VwLmZyb21TZWN1cml0eUdyb3VwSWQodGhpcywgYHNnLSR7aWR9YCwgaWQsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsbG93QWxsT3V0Ym91bmQ6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXV0YWJsZTogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBnZXRTdWJuZXRzQnlHcm91cE5hbWUoc3VibmV0R3JvdXBOYW1lOiBTdWJuZXRHcm91cCk6IFN1Ym5ldFNlbGVjdGlvbiB8IHVuZGVmaW5lZCB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBzdWJuZXRHcm91cE5hbWU6IHRoaXMuc3VibmV0TWFwcGluZ1tzdWJuZXRHcm91cE5hbWVdLnN1Ym5ldEdyb3VwTmFtZSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBnZXRTdWJuZXRTZWN1cml0eUdyb3VwcyhzdWJuZXRHcm91cE5hbWU6IFN1Ym5ldEdyb3VwKTogSVNlY3VyaXR5R3JvdXBbXSB8IHVuZGVmaW5lZCB7XG4gICAgICAgIHJldHVybiB0aGlzLnN1Ym5ldE1hcHBpbmdbc3VibmV0R3JvdXBOYW1lXS5zZWN1cml0eUdyb3VwcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZWFkIEpTT04gc3RyaW5nIHN0b3JlZCBpbiBTU00gUGFyYW1ldGVyU3RvcmUgYW5kIHJldHVybiBvYmplY3RcbiAgICAgKlxuICAgICAqIFRoaXMgZnVuY3Rpb24gcmV0dXJucyBhIGRlZmF1bHQgdmFsdWUgaWYgdGhlIHZhbHVlIHJldHVybmVkIGZyb20gYHNzbS5TdHJpbmdQYXJhbWV0ZXIudmFsdWVGcm9tTG9va3VwYCBpcyBhbiB0b2tlblxuICAgICAqIHNvIHRoYXQgdGhlIHN5bnRoIHByb2Nlc3MgY2FuIGNvbnRpbnVlLiBJdCBoYXBwZW5zIHdoZW4gY2RrIGRvZXNuJ3QgaGF2ZSB0aGlzIHNzbSBwYXJhbWV0ZXIgY2FjaGVkIGluIGNkay5jb250ZXh0Lmpzb25cbiAgICAgKiBcbiAgICAgKiBEdXJpbmcgY2RrIHN5bnRoIHRpbWUsIFNTTSBwYXJhbWV0ZXIgdmFsdWVzIGNvdWxkIGJlIHJlc29sdmVkIGludG8gdG9rZW4gZmlyc3RcbiAgICAgKiBiZWZvcmUgdGhlIHJlYWwgc3RyaW5nIHZhbHVlIGlzIGZldGNoZWQgZnJvbSB0aGUgc2VydmVyLiBPbmNlIHRoZSB2YWx1ZSBpcyBmZXRjaGVkXG4gICAgICogaXQgd2lsbCBiZSBzdG9yZWQgaW4gY2RrLmNvbnRleHQuanNvbi5cbiAgICAgKlxuICAgICAqIENESyB3aWxsIHJ1biB0aGUgc2FtZSBzdGFjayBhIGZldyBwYXNzZXMgZHVyaW5nIHRoZSBzeW50aC4gVGhlIHRva2VuIHdpbGwgb25seVxuICAgICAqIGJlIHJlc29sdmVkIGluIHRoZSByZWFsIHN0cmluZyBpbiB0aGUgbGF0ZXIgcGFzc2VzIGJ1dCBub3QgdGhlIGZpcnN0IHBhc3MuXG4gICAgICpcbiAgICAgKiBJZiB0aGUgU1NNIHBhcmFtZXRlciB2YWx1ZSBuZWVkIHRvIGJlIHBhcnNlZCBhbmQgdXNlZCBpbiB0aGUgc3RhY2sgY29kZSwgdGhlXG4gICAgICogc3RhY2sgY29kZSB3aWxsIG9ubHkgZ2V0IHRoZSB0b2tlbiBpbiBmaXJzdCBwYXNzIGFuZCB3aWxsIGZhaWwgYW5kIHRodXNcbiAgICAgKiBwcmV2ZW50IHRoZSBzdGFjayBzeW50aCB0byBiZSBjb21wbGV0ZWQuXG4gICAgICpcbiAgICAgKiBUaGUgd29ya2Fyb3VuZCBpcyB0byBydW4gY2RrIHN5bnRoIHR3aWNlLCB3aXRoIHJlZnJlc2hDb250ZXh0IGZsYWcgaW4gdGhlXG4gICAgICogZmlyc3QgdGltZS4gV2hlbiB0aGlzIGZsYWcgaXMgc2V0LCB0aGUgc3RhY2sgc2hvdWxkIHJ1biBzb21lIHNwZWNpYWwgY29kZVxuICAgICAqIHdoaWNoIG9ubHkgcmV0cmlldmUgU1NNIHBhcmFtZXRlcnMuIFRoaXMgd2lsbCBmb3JjZSBjZGsgdG8gcmV0cmlldmUgaXQgZnJvbVxuICAgICAqIHRoZSBlbnZpcm9ubWVudCBhbmQgc3RvcmUgaXQgaW4gY2RrLmNvbnRleHQuanNvbi4gVGhlIHN0YWNrIGNvZGUgc2hvdWxkIG5vdFxuICAgICAqIHBhcnNlIG9yIGludGVycHJldGUgdGhlIHZhbHVlLlxuICAgIFxuICAgICAqIEFmdGVyIHRoZSBmaXJzdCBzeW50aCBjb21wbGV0ZWQgKHdpdGggb25seSB0aGUgU1NNIHBhcmFtZXRlcnMgaW4gdGhlIHN0YWNrKSxcbiAgICAgKiBydW4gY2RrIHN5bnRoIGFnYWluIHdpdGhvdXQgc2V0dGluZyB0aGlzIGZsYWcgKHJlZnJlc2hDb250ZXh0KS4gVGhlIHNlY29uZFxuICAgICAqIGNkayBzeW50aCB3aWxsIHJlYWQgdGhlIFNTTSBwYXJhbWV0ZXIgdmFsdWVzIGZyb20gY2RrLmNvbnRleHQuanNvbiBhbmQgd2lsbCBwYXNzLlxuICAgICAqXG4gICAgICogQHBhcmFtIHBhcmFtZXRlck5hbWUgTmFtZSBvZiB0aGUgU1NNIHBhcmFtZXRlclxuICAgICAqIEBwYXJhbSBkZWZhdWx0VmFsdWUgVGhlIGRlZmF1bHQgdmFsdWUgb2YgdGhpcyBTU00gcGFyYW1ldGVyIGlmIHRoZSB2YWx1ZSBpcyBub3QgcmV0cmlldmUgeWV0LlxuICAgICAqIEByZXR1cm5zIEpTT04gT2JqZWN0IHRoYXQgc3RvcmVkIGluIHRoaXMgU1NNIHBhcmFtdGVyIG9yIHRoZSBkZWZhdWx0IHZhbHVlXG4gICAgICovXG4gICAgcmVhZEpTT05QYXJhbWV0ZXI8VD4ocGFyYW1ldGVyTmFtZTogc3RyaW5nLCBkZWZhdWx0VmFsdWU6IFQpOiBUIHtcbiAgICAgICAgY29uc3QgdmFsdWUgPSBzc20uU3RyaW5nUGFyYW1ldGVyLnZhbHVlRnJvbUxvb2t1cCh0aGlzLCBwYXJhbWV0ZXJOYW1lKTtcbiAgICAgICAgaWYgKHZhbHVlID09PSBgZHVtbXktdmFsdWUtZm9yLSR7cGFyYW1ldGVyTmFtZX1gKSB7XG4gICAgICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UodmFsdWUpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmVhZFN0cmluZ1BhcmFtZXRlcihwYXJhbWV0ZXJOYW1lOiBzdHJpbmcsIGRlZmF1bHRWYWx1ZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgY29uc3QgdmFsdWUgPSBzc20uU3RyaW5nUGFyYW1ldGVyLnZhbHVlRnJvbUxvb2t1cCh0aGlzLCBwYXJhbWV0ZXJOYW1lKTtcbiAgICAgICAgaWYgKHZhbHVlID09PSBgZHVtbXktdmFsdWUtZm9yLSR7cGFyYW1ldGVyTmFtZX1gKSB7XG4gICAgICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgICAgICB9XG4gICAgfVxufVxuIl19