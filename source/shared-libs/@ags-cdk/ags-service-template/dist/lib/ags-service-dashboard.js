"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.AgsServiceDashboard = void 0;
/*
  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
  
  Licensed under the Apache License, Version 2.0 (the "License").
  You may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  
      http://www.apache.org/licenses/LICENSE-2.0
  
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
*/
const cdk = require("@aws-cdk/core");
const cw = require("@aws-cdk/aws-cloudwatch");
class AgsServiceDashboard extends cdk.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        this.keyMetrics = new Map();
        const dashboard = new cw.Dashboard(this, `${props.serviceName}-dashboard`, {
            dashboardName: props.dashboardName,
        });
        // canary and api gateway widgets
        if (props.apiGateway) {
            dashboard.addWidgets(...this.createApiWidgets(props.apiGateway, props.canaryName));
        }
        // lambda widgets
        dashboard.addWidgets(...props.lambdas
            .map((lambda) => this.createLambdaWidgets(lambda))
            .reduce((previous, current) => previous.concat(current)));
        // dynamo db
        if (props.dynamoDbTables && props.dynamoDbTables.length > 0) {
            dashboard.addWidgets(...props.dynamoDbTables
                .map((table) => this.createDynamoDbWidgets(table))
                .reduce((previous, current) => previous.concat(current)));
        }
        if (props.additionalWidgets && props.additionalWidgets.length > 0) {
            dashboard.addWidgets(...props.additionalWidgets);
        }
        this.dashboard = dashboard;
    }
    createLambdaWidgets(lambda) {
        var _a;
        const prefix = (_a = lambda.friendlyName) !== null && _a !== void 0 ? _a : lambda.functionName;
        const successRateMetrics = this.createSuccessRateMetrics(lambda);
        const maximumDurationMetrics = this.lambdaMetric(lambda, 'Maximum', 'Duration', cw.Statistic.MAXIMUM, cw.Unit.MILLISECONDS);
        const averageDurationMetrics = this.lambdaMetric(lambda, 'Average', 'Duration', cw.Statistic.AVERAGE, cw.Unit.MILLISECONDS);
        const minDurationMetrics = this.lambdaMetric(lambda, 'Minimum', 'Duration', cw.Statistic.MINIMUM, cw.Unit.MILLISECONDS);
        this.keyMetrics.set('SUCESS_RATE', successRateMetrics);
        return [
            this.lambdaWidget(`${prefix} - Duration`, [
                minDurationMetrics,
                maximumDurationMetrics,
                averageDurationMetrics,
            ]),
            this.createGraphWidget({
                title: `${prefix} -  Success Rate`,
                left: [successRateMetrics],
                leftYAxis: { max: 100, min: 0, label: 'Percent', showUnits: false },
            }),
        ];
    }
    createSuccessRateMetrics(lambda) {
        const invocations = this.lambdaMetric(lambda, 'Invocations', 'Invocations', cw.Statistic.SUM, cw.Unit.COUNT);
        const errorCount = this.lambdaMetric(lambda, 'Error', 'Errors', cw.Statistic.SUM, cw.Unit.COUNT);
        const successRateMetrics = new cw.MathExpression({
            expression: '100 - 100 * errors / MAX([errors, invocations])',
            usingMetrics: {
                errors: errorCount,
                invocations: invocations,
            },
            period: cdk.Duration.minutes(5),
            label: 'Success rate',
        });
        return successRateMetrics;
    }
    createApiWidgets(apg, canaryName) {
        const metrics = [];
        if (canaryName) {
            metrics.push(this.apiGatewayWidget('Canary Status', [
                this.createGraphMetric({
                    metricName: 'SuccessPercent',
                    namespace: 'CloudWatchSynthetics',
                    label: 'Canary Status',
                    statistic: cw.Statistic.AVERAGE,
                    unit: cw.Unit.PERCENT,
                    dimensions: { CanaryName: canaryName },
                }),
            ]));
        }
        metrics.push(this.apiGatewayWidget('API Invocation', apg.endpoints.map((api) => {
            var _a;
            return this.apiGatewayMetric(apg.apiName, (_a = api.friendlyName) !== null && _a !== void 0 ? _a : `${api.method} ${api.resource}`, 'Count', cw.Statistic.SUM, cw.Unit.COUNT, api.method, api.resource);
        })), this.apiGatewayWidget('API Latency', apg.endpoints.map((api) => {
            var _a;
            return this.apiGatewayMetric(apg.apiName, (_a = api.friendlyName) !== null && _a !== void 0 ? _a : `${api.method} ${api.resource}`, 'Latency', cw.Statistic.AVERAGE, cw.Unit.MILLISECONDS, api.method, api.resource);
        })), this.apiGatewayWidget('API Errors', apg.endpoints.map((api) => {
            var _a;
            return this.apiGatewayMetric(apg.apiName, (_a = api.friendlyName) !== null && _a !== void 0 ? _a : `${api.method} ${api.resource}`, '4XXError', cw.Statistic.SUM, cw.Unit.COUNT, api.method, api.resource);
        }), apg.endpoints.map((api) => {
            var _a;
            return this.apiGatewayMetric(apg.apiName, (_a = api.friendlyName) !== null && _a !== void 0 ? _a : `${api.method} ${api.resource}`, '5XXError', cw.Statistic.SUM, cw.Unit.COUNT, api.method, api.resource);
        }), '4XX Errors', '5XX Errors'));
        return metrics;
    }
    lambdaWidget(title, metrics) {
        return this.createGraphWidget({ title, left: metrics });
    }
    lambdaMetric(lambda, label, metricName, statistic, unit) {
        return this.createGraphMetric({
            label,
            metricName,
            namespace: 'AWS/Lambda',
            statistic,
            unit,
            dimensions: { FunctionName: lambda.functionName },
        });
    }
    createDynamoDbWidgets(dynamoDbTable) {
        var _a;
        const prefix = (_a = dynamoDbTable.friendlyTableName) !== null && _a !== void 0 ? _a : dynamoDbTable.tableName;
        return [
            this.ddbWidget(`${prefix} - Capacity`, [
                this.ddbMetric(dynamoDbTable.tableName, 'Provisioned Read', 'ProvisionedReadCapacityUnits', cw.Statistic.AVERAGE, cw.Unit.COUNT),
                this.ddbMetric(dynamoDbTable.tableName, 'Consumed Read', 'ConsumedReadCapacityUnits', cw.Statistic.AVERAGE, cw.Unit.COUNT),
                this.ddbMetric(dynamoDbTable.tableName, 'Provisioned Read', 'ProvisionedWriteCapacityUnits', cw.Statistic.AVERAGE, cw.Unit.COUNT),
                this.ddbMetric(dynamoDbTable.tableName, 'Consumed Read', 'ConsumedWriteCapacityUnits', cw.Statistic.AVERAGE, cw.Unit.COUNT),
            ]),
            this.ddbWidget(`${prefix} - Latency`, [
                this.ddbMetric(dynamoDbTable.tableName, 'Get Latency', 'SuccessfulRequestLatency', cw.Statistic.AVERAGE, cw.Unit.MILLISECONDS, { Operation: 'GetItem' }),
                this.ddbMetric(dynamoDbTable.tableName, 'Put Latency', 'SuccessfulRequestLatency', cw.Statistic.AVERAGE, cw.Unit.MILLISECONDS, { Operation: 'PutItem' }),
                this.ddbMetric(dynamoDbTable.tableName, 'Scan Latency', 'SuccessfulRequestLatency', cw.Statistic.AVERAGE, cw.Unit.MILLISECONDS, { Operation: 'Scan' }),
                this.ddbMetric(dynamoDbTable.tableName, 'Query Latency', 'SuccessfulRequestLatency', cw.Statistic.AVERAGE, cw.Unit.MILLISECONDS, { Operation: 'Query' }),
            ]),
            this.ddbWidget(`${prefix} - Errors`, [
                this.ddbMetric(dynamoDbTable.tableName, 'Get', 'SystemErrors', cw.Statistic.SUM, cw.Unit.COUNT, {
                    Operation: 'GetItem',
                }),
                this.ddbMetric(dynamoDbTable.tableName, 'Batch Get', 'SystemErrors', cw.Statistic.SUM, cw.Unit.COUNT, {
                    Operation: 'BatchGetItem',
                }),
                this.ddbMetric(dynamoDbTable.tableName, 'Scan', 'SystemErrors', cw.Statistic.SUM, cw.Unit.COUNT, {
                    Operation: 'Scan',
                }),
                this.ddbMetric(dynamoDbTable.tableName, 'Query', 'SystemErrors', cw.Statistic.SUM, cw.Unit.COUNT, {
                    Operation: 'Query',
                }),
                this.ddbMetric(dynamoDbTable.tableName, 'Put', 'SystemErrors', cw.Statistic.SUM, cw.Unit.COUNT, {
                    Operation: 'PutItem',
                }),
                this.ddbMetric(dynamoDbTable.tableName, 'Batch Write', 'SystemErrors', cw.Statistic.SUM, cw.Unit.COUNT, {
                    Operation: 'BatchWriteItem',
                }),
                this.ddbMetric(dynamoDbTable.tableName, 'Update', 'SystemErrors', cw.Statistic.SUM, cw.Unit.COUNT, {
                    Operation: 'UpdateItem',
                }),
                this.ddbMetric(dynamoDbTable.tableName, 'Delete', 'SystemErrors', cw.Statistic.SUM, cw.Unit.COUNT, {
                    Operation: 'DeleteItem',
                }),
            ]),
            this.ddbWidget(`${prefix} - Throttled Requests`, [
                this.ddbMetric(dynamoDbTable.tableName, 'Throttled Requests', 'ThrottledRequests', cw.Statistic.SUM, cw.Unit.COUNT),
            ]),
        ];
    }
    ddbMetric(tableName, label, metricName, statistic, unit, 
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    dimensions) {
        return this.createGraphMetric({
            label,
            metricName,
            statistic,
            namespace: 'AWS/DynamoDB',
            unit,
            dimensions: { ...dimensions, TableName: tableName },
        });
    }
    ddbWidget(title, metrics) {
        return this.createGraphWidget({ title, left: metrics });
    }
    apiGatewayWidget(title, leftMetrics, rightMetrics, leftLabel, rightLabel) {
        return this.createGraphWidget({
            title,
            left: leftMetrics,
            right: rightMetrics,
            leftYAxis: { label: leftLabel },
            rightYAxis: { label: rightLabel },
        });
    }
    apiGatewayMetric(apiName, label, metricName, statistic, unit, method, resource, 
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    dimensions) {
        return this.createGraphMetric({
            label,
            metricName,
            statistic,
            unit,
            namespace: 'AWS/ApiGateway',
            dimensions: {
                ...dimensions,
                ApiName: apiName,
                Stage: 'prod',
                Method: method,
                Resource: resource,
            },
        });
    }
    createGraphWidget(props) {
        return new cw.GraphWidget({ height: 6, width: 6, liveData: true, ...props });
    }
    createGraphMetric(props) {
        return new cw.Metric(props);
    }
}
exports.AgsServiceDashboard = AgsServiceDashboard;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWdzLXNlcnZpY2UtZGFzaGJvYXJkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vbGliL2Fncy1zZXJ2aWNlLWRhc2hib2FyZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQTs7Ozs7Ozs7Ozs7Ozs7RUFjRTtBQUNGLHFDQUFxQztBQUNyQyw4Q0FBOEM7QUEyQjlDLE1BQWEsbUJBQW9CLFNBQVEsR0FBRyxDQUFDLFNBQVM7SUFJbEQsWUFBWSxLQUFvQixFQUFFLEVBQVUsRUFBRSxLQUErQjtRQUN6RSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ2pCLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUM1QixNQUFNLFNBQVMsR0FBRyxJQUFJLEVBQUUsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLEdBQUcsS0FBSyxDQUFDLFdBQVcsWUFBWSxFQUFFO1lBQ3ZFLGFBQWEsRUFBRSxLQUFLLENBQUMsYUFBYTtTQUNyQyxDQUFDLENBQUM7UUFFSCxpQ0FBaUM7UUFDakMsSUFBSSxLQUFLLENBQUMsVUFBVSxFQUFFO1lBQ2xCLFNBQVMsQ0FBQyxVQUFVLENBQ2hCLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxVQUFVLEVBQUUsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUMvRCxDQUFDO1NBQ0w7UUFFRCxpQkFBaUI7UUFDakIsU0FBUyxDQUFDLFVBQVUsQ0FDaEIsR0FBRyxLQUFLLENBQUMsT0FBTzthQUNYLEdBQUcsQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLE1BQU0sQ0FBQyxDQUFDO2FBQ2pELE1BQU0sQ0FBQyxDQUFDLFFBQVEsRUFBRSxPQUFPLEVBQUUsRUFBRSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FDL0QsQ0FBQztRQUVGLFlBQVk7UUFDWixJQUFJLEtBQUssQ0FBQyxj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QUFRLEVBQUUsUUFBUTthQUNyQjtTQUNKLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFTyxpQkFBaUIsQ0FBQyxLQUEwQjtRQUNoRCxPQUFPLElBQUksRUFBRSxDQUFDLFdBQVcsQ0FBQyxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLEdBQUcsS0FBSyxFQUFFLENBQUMsQ0FBQztJQUNqRixDQUFDO0lBRU8saUJBQWlCLENBQUMsS0FBcUI7UUFDM0MsT0FBTyxJQUFJLEVBQUUsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDaEMsQ0FBQztDQUNKO0FBL2JELGtEQStiQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIFxuICBDb3B5cmlnaHQgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAgXG4gIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIikuXG4gIFlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gIFxuICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gIFxuICBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4qL1xuaW1wb3J0ICogYXMgY2RrIGZyb20gJ0Bhd3MtY2RrL2NvcmUnO1xuaW1wb3J0ICogYXMgY3cgZnJvbSAnQGF3cy1jZGsvYXdzLWNsb3Vkd2F0Y2gnO1xuXG5leHBvcnQgaW50ZXJmYWNlIEFwaUdhdGV3YXlXaWRnZXRQcm9wcyB7XG4gICAgYXBpTmFtZTogc3RyaW5nO1xuICAgIGVuZHBvaW50czogeyBtZXRob2Q6IHN0cmluZzsgcmVzb3VyY2U6IHN0cmluZzsgZnJpZW5kbHlOYW1lPzogc3RyaW5nIH1bXTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBMYW1iZGFXaWRnZXRQcm9wcyB7XG4gICAgZnVuY3Rpb25OYW1lOiBzdHJpbmc7XG4gICAgZnJpZW5kbHlOYW1lPzogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIER5bmFtb0RiV2lkZ2V0UHJvcHMge1xuICAgIHRhYmxlTmFtZTogc3RyaW5nO1xuICAgIGZyaWVuZGx5VGFibGVOYW1lPzogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFnc1NlcnZpY2VEYXNoYm9hcmRQcm9wcyB7XG4gICAgZGFzaGJvYXJkTmFtZT86IHN0cmluZztcbiAgICBzZXJ2aWNlTmFtZTogc3RyaW5nO1xuICAgIGNhbmFyeU5hbWU/OiBzdHJpbmc7XG4gICAgbGFtYmRhczogTGFtYmRhV2lkZ2V0UHJvcHNbXTtcbiAgICBhcGlHYXRld2F5PzogQXBpR2F0ZXdheVdpZGdldFByb3BzO1xuICAgIGR5bmFtb0RiVGFibGVzPzogRHluYW1vRGJXaWRnZXRQcm9wc1tdO1xuICAgIGFkZGl0aW9uYWxXaWRnZXRzPzogY3cuSVdpZGdldFtdO1xufVxuXG5leHBvcnQgY2xhc3MgQWdzU2VydmljZURhc2hib2FyZCBleHRlbmRzIGNkay5Db25zdHJ1Y3Qge1xuICAgIHB1YmxpYyByZWFkb25seSBkYXNoYm9hcmQ6IGN3LkRhc2hib2FyZDtcbiAgICBwdWJsaWMga2V5TWV0cmljczogTWFwPHN0cmluZywgY3cuSU1ldHJpYz47XG5cbiAgICBjb25zdHJ1Y3RvcihzY29wZTogY2RrLkNvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IEFnc1NlcnZpY2VEYXNoYm9hcmRQcm9wcykge1xuICAgICAgICBzdXBlcihzY29wZSwgaWQpO1xuICAgICAgICB0aGlzLmtleU1ldHJpY3MgPSBuZXcgTWFwKCk7XG4gICAgICAgIGNvbnN0IGRhc2hib2FyZCA9IG5ldyBjdy5EYXNoYm9hcmQodGhpcywgYCR7cHJvcHMuc2VydmljZU5hbWV9LWRhc2hib2FyZGAsIHtcbiAgICAgICAgICAgIGRhc2hib2FyZE5hbWU6IHByb3BzLmRhc2hib2FyZE5hbWUsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIGNhbmFyeSBhbmQgYXBpIGdhdGV3YXkgd2lkZ2V0c1xuICAgICAgICBpZiAocHJvcHMuYXBpR2F0ZXdheSkge1xuICAgICAgICAgICAgZGFzaGJvYXJkLmFkZFdpZGdldHMoXG4gICAgICAgICAgICAgICAgLi4udGhpcy5jcmVhdGVBcGlXaWRnZXRzKHByb3BzLmFwaUdhdGV3YXksIHByb3BzLmNhbmFyeU5hbWUpXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gbGFtYmRhIHdpZGdldHNcbiAgICAgICAgZGFzaGJvYXJkLmFkZFdpZGdldHMoXG4gICAgICAgICAgICAuLi5wcm9wcy5sYW1iZGFzXG4gICAgICAgICAgICAgICAgLm1hcCgobGFtYmRhKSA9PiB0aGlzLmNyZWF0ZUxhbWJkYVdpZGdldHMobGFtYmRhKSlcbiAgICAgICAgICAgICAgICAucmVkdWNlKChwcmV2aW91cywgY3VycmVudCkgPT4gcHJldmlvdXMuY29uY2F0KGN1cnJlbnQpKVxuICAgICAgICApO1xuXG4gICAgICAgIC8vIGR5bmFtbyBkYlxuICAgICAgICBpZiAocHJvcHMuZHluYW1vRGJUYWJsZXMgJiYgcHJvcHMuZHluYW1vRGJUYWJsZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgZGFzaGJvYXJkLmFkZFdpZGdldHMoXG4gICAgICAgICAgICAgICAgLi4ucHJvcHMuZHluYW1vRGJUYWJsZXNcbiAgICAgICAgICAgICAgICAgICAgLm1hcCgodGFibGUpID0+IHRoaXMuY3JlYXRlRHluYW1vRGJXaWRnZXRzKHRhYmxlKSlcbiAgICAgICAgICAgICAgICAgICAgLnJlZHVjZSgocHJldmlvdXMsIGN1cnJlbnQpID0+IHByZXZpb3VzLmNvbmNhdChjdXJyZW50KSlcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocHJvcHMuYWRkaXRpb25hbFdpZGdldHMgJiYgcHJvcHMuYWRkaXRpb25hbFdpZGdldHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgZGFzaGJvYXJkLmFkZFdpZGdldHMoLi4ucHJvcHMuYWRkaXRpb25hbFdpZGdldHMpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZGFzaGJvYXJkID0gZGFzaGJvYXJkO1xuICAgIH1cblxuICAgIHByaXZhdGUgY3JlYXRlTGFtYmRhV2lkZ2V0cyhsYW1iZGE6IExhbWJkYVdpZGdldFByb3BzKTogY3cuSVdpZGdldFtdIHtcbiAgICAgICAgY29uc3QgcHJlZml4ID0gbGFtYmRhLmZyaWVuZGx5TmFtZSA/PyBsYW1iZGEuZnVuY3Rpb25OYW1lO1xuICAgICAgICBjb25zdCBzdWNjZXNzUmF0ZU1ldHJpY3MgPSB0aGlzLmNyZWF0ZVN1Y2Nlc3NSYXRlTWV0cmljcyhsYW1iZGEpO1xuICAgICAgICBjb25zdCBtYXhpbXVtRHVyYXRpb25NZXRyaWNzID0gdGhpcy5sYW1iZGFNZXRyaWMoXG4gICAgICAgICAgICBsYW1iZGEsXG4gICAgICAgICAgICAnTWF4aW11bScsXG4gICAgICAgICAgICAnRHVyYXRpb24nLFxuICAgICAgICAgICAgY3cuU3RhdGlzdGljLk1BWElNVU0sXG4gICAgICAgICAgICBjdy5Vbml0Lk1JTExJU0VDT05EU1xuICAgICAgICApO1xuICAgICAgICBjb25zdCBhdmVyYWdlRHVyYXRpb25NZXRyaWNzID0gdGhpcy5sYW1iZGFNZXRyaWMoXG4gICAgICAgICAgICBsYW1iZGEsXG4gICAgICAgICAgICAnQXZlcmFnZScsXG4gICAgICAgICAgICAnRHVyYXRpb24nLFxuICAgICAgICAgICAgY3cuU3RhdGlzdGljLkFWRVJBR0UsXG4gICAgICAgICAgICBjdy5Vbml0Lk1JTExJU0VDT05EU1xuICAgICAgICApO1xuICAgICAgICBjb25zdCBtaW5EdXJhdGlvbk1ldHJpY3MgPSB0aGlzLmxhbWJkYU1ldHJpYyhcbiAgICAgICAgICAgIGxhbWJkYSxcbiAgICAgICAgICAgICdNaW5pbXVtJyxcbiAgICAgICAgICAgICdEdXJhdGlvbicsXG4gICAgICAgICAgICBjdy5TdGF0aXN0aWMuTUlOSU1VTSxcbiAgICAgICAgICAgIGN3LlVuaXQuTUlMTElTRUNPTkRTXG4gICAgICAgICk7XG4gICAgICAgIHRoaXMua2V5TWV0cmljcy5zZXQoJ1NVQ0VTU19SQVRFJywgc3VjY2Vzc1JhdGVNZXRyaWNzKTtcblxuICAgICAgICByZXR1cm4gW1xuICAgICAgICAgICAgdGhpcy5sYW1iZGFXaWRnZXQoYCR7cHJlZml4fSAtIER1cmF0aW9uYCwgW1xuICAgICAgICAgICAgICAgIG1pbkR1cmF0aW9uTWV0cmljcyxcbiAgICAgICAgICAgICAgICBtYXhpbXVtRHVyYXRpb25NZXRyaWNzLFxuICAgICAgICAgICAgICAgIGF2ZXJhZ2VEdXJhdGlvbk1ldHJpY3MsXG4gICAgICAgICAgICBdKSxcbiAgICAgICAgICAgIHRoaXMuY3JlYXRlR3JhcGhXaWRnZXQoe1xuICAgICAgICAgICAgICAgIHRpdGxlOiBgJHtwcmVmaXh9IC0gIFN1Y2Nlc3MgUmF0ZWAsXG4gICAgICAgICAgICAgICAgbGVmdDogW3N1Y2Nlc3NSYXRlTWV0cmljc10sXG4gICAgICAgICAgICAgICAgbGVmdFlBeGlzOiB7IG1heDogMTAwLCBtaW46IDAsIGxhYmVsOiAnUGVyY2VudCcsIHNob3dVbml0czogZmFsc2UgfSxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICBdO1xuICAgIH1cblxuICAgIHByaXZhdGUgY3JlYXRlU3VjY2Vzc1JhdGVNZXRyaWNzKGxhbWJkYTogTGFtYmRhV2lkZ2V0UHJvcHMpIHtcbiAgICAgICAgY29uc3QgaW52b2NhdGlvbnM6IGN3LklNZXRyaWMgPSB0aGlzLmxhbWJkYU1ldHJpYyhcbiAgICAgICAgICAgIGxhbWJkYSxcbiAgICAgICAgICAgICdJbnZvY2F0aW9ucycsXG4gICAgICAgICAgICAnSW52b2NhdGlvbnMnLFxuICAgICAgICAgICAgY3cuU3RhdGlzdGljLlNVTSxcbiAgICAgICAgICAgIGN3LlVuaXQuQ09VTlRcbiAgICAgICAgKTtcblxuICAgICAgICBjb25zdCBlcnJvckNvdW50OiBjdy5JTWV0cmljID0gdGhpcy5sYW1iZGFNZXRyaWMoXG4gICAgICAgICAgICBsYW1iZGEsXG4gICAgICAgICAgICAnRXJyb3InLFxuICAgICAgICAgICAgJ0Vycm9ycycsXG4gICAgICAgICAgICBjdy5TdGF0aXN0aWMuU1VNLFxuICAgICAgICAgICAgY3cuVW5pdC5DT1VOVFxuICAgICAgICApO1xuXG4gICAgICAgIGNvbnN0IHN1Y2Nlc3NSYXRlTWV0cmljcyA9IG5ldyBjdy5NYXRoRXhwcmVzc2lvbih7XG4gICAgICAgICAgICBleHByZXNzaW9uOiAnMTAwIC0gMTAwICogZXJyb3JzIC8gTUFYKFtlcnJvcnMsIGludm9jYXRpb25zXSknLFxuICAgICAgICAgICAgdXNpbmdNZXRyaWNzOiB7XG4gICAgICAgICAgICAgICAgZXJyb3JzOiBlcnJvckNvdW50LFxuICAgICAgICAgICAgICAgIGludm9jYXRpb25zOiBpbnZvY2F0aW9ucyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBwZXJpb2Q6IGNkay5EdXJhdGlvbi5taW51dGVzKDUpLFxuICAgICAgICAgICAgbGFiZWw6ICdTdWNjZXNzIHJhdGUnLFxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gc3VjY2Vzc1JhdGVNZXRyaWNzO1xuICAgIH1cblxuICAgIHByaXZhdGUgY3JlYXRlQXBpV2lkZ2V0cyhcbiAgICAgICAgYXBnOiBBcGlHYXRld2F5V2lkZ2V0UHJvcHMsXG4gICAgICAgIGNhbmFyeU5hbWU/OiBzdHJpbmdcbiAgICApOiBjdy5JV2lkZ2V0W10ge1xuICAgICAgICBjb25zdCBtZXRyaWNzID0gW107XG5cbiAgICAgICAgaWYgKGNhbmFyeU5hbWUpIHtcbiAgICAgICAgICAgIG1ldHJpY3MucHVzaChcbiAgICAgICAgICAgICAgICB0aGlzLmFwaUdhdGV3YXlXaWRnZXQoJ0NhbmFyeSBTdGF0dXMnLCBbXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlR3JhcGhNZXRyaWMoe1xuICAgICAgICAgICAgICAgICAgICAgICAgbWV0cmljTmFtZTogJ1N1Y2Nlc3NQZXJjZW50JyxcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWVzcGFjZTogJ0Nsb3VkV2F0Y2hTeW50aGV0aWNzJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOiAnQ2FuYXJ5IFN0YXR1cycsXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0aXN0aWM6IGN3LlN0YXRpc3RpYy5BVkVSQUdFLFxuICAgICAgICAgICAgICAgICAgICAgICAgdW5pdDogY3cuVW5pdC5QRVJDRU5ULFxuICAgICAgICAgICAgICAgICAgICAgICAgZGltZW5zaW9uczogeyBDYW5hcnlOYW1lOiBjYW5hcnlOYW1lIH0sXG4gICAgICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIF0pXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgbWV0cmljcy5wdXNoKFxuICAgICAgICAgICAgdGhpcy5hcGlHYXRld2F5V2lkZ2V0KFxuICAgICAgICAgICAgICAgICdBUEkgSW52b2NhdGlvbicsXG4gICAgICAgICAgICAgICAgYXBnLmVuZHBvaW50cy5tYXAoKGFwaSkgPT5cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcGlHYXRld2F5TWV0cmljKFxuICAgICAgICAgICAgICAgICAgICAgICAgYXBnLmFwaU5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICBhcGkuZnJpZW5kbHlOYW1lID8/IGAke2FwaS5tZXRob2R9ICR7YXBpLnJlc291cmNlfWAsXG4gICAgICAgICAgICAgICAgICAgICAgICAnQ291bnQnLFxuICAgICAgICAgICAgICAgICAgICAgICAgY3cuU3RhdGlzdGljLlNVTSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGN3LlVuaXQuQ09VTlQsXG4gICAgICAgICAgICAgICAgICAgICAgICBhcGkubWV0aG9kLFxuICAgICAgICAgICAgICAgICAgICAgICAgYXBpLnJlc291cmNlXG4gICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICApLFxuICAgICAgICAgICAgdGhpcy5hcGlHYXRld2F5V2lkZ2V0KFxuICAgICAgICAgICAgICAgICdBUEkgTGF0ZW5jeScsXG4gICAgICAgICAgICAgICAgYXBnLmVuZHBvaW50cy5tYXAoKGFwaSkgPT5cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcGlHYXRld2F5TWV0cmljKFxuICAgICAgICAgICAgICAgICAgICAgICAgYXBnLmFwaU5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICBhcGkuZnJpZW5kbHlOYW1lID8/IGAke2FwaS5tZXRob2R9ICR7YXBpLnJlc291cmNlfWAsXG4gICAgICAgICAgICAgICAgICAgICAgICAnTGF0ZW5jeScsXG4gICAgICAgICAgICAgICAgICAgICAgICBjdy5TdGF0aXN0aWMuQVZFUkFHRSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGN3LlVuaXQuTUlMTElTRUNPTkRTLFxuICAgICAgICAgICAgICAgICAgICAgICAgYXBpLm1ldGhvZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwaS5yZXNvdXJjZVxuICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIHRoaXMuYXBpR2F0ZXdheVdpZGdldChcbiAgICAgICAgICAgICAgICAnQVBJIEVycm9ycycsXG4gICAgICAgICAgICAgICAgYXBnLmVuZHBvaW50cy5tYXAoKGFwaSkgPT5cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcGlHYXRld2F5TWV0cmljKFxuICAgICAgICAgICAgICAgICAgICAgICAgYXBnLmFwaU5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICBhcGkuZnJpZW5kbHlOYW1lID8/IGAke2FwaS5tZXRob2R9ICR7YXBpLnJlc291cmNlfWAsXG4gICAgICAgICAgICAgICAgICAgICAgICAnNFhYRXJyb3InLFxuICAgICAgICAgICAgICAgICAgICAgICAgY3cuU3RhdGlzdGljLlNVTSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGN3LlVuaXQuQ09VTlQsXG4gICAgICAgICAgICAgICAgICAgICAgICBhcGkubWV0aG9kLFxuICAgICAgICAgICAgICAgICAgICAgICAgYXBpLnJlc291cmNlXG4gICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgIGFwZy5lbmRwb2ludHMubWFwKChhcGkpID0+XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXBpR2F0ZXdheU1ldHJpYyhcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwZy5hcGlOYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgYXBpLmZyaWVuZGx5TmFtZSA/PyBgJHthcGkubWV0aG9kfSAke2FwaS5yZXNvdXJjZX1gLFxuICAgICAgICAgICAgICAgICAgICAgICAgJzVYWEVycm9yJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGN3LlN0YXRpc3RpYy5TVU0sXG4gICAgICAgICAgICAgICAgICAgICAgICBjdy5Vbml0LkNPVU5ULFxuICAgICAgICAgICAgICAgICAgICAgICAgYXBpLm1ldGhvZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwaS5yZXNvdXJjZVxuICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAnNFhYIEVycm9ycycsXG4gICAgICAgICAgICAgICAgJzVYWCBFcnJvcnMnXG4gICAgICAgICAgICApXG4gICAgICAgICk7XG5cbiAgICAgICAgcmV0dXJuIG1ldHJpY3M7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBsYW1iZGFXaWRnZXQodGl0bGU6IHN0cmluZywgbWV0cmljczogY3cuSU1ldHJpY1tdKTogY3cuSVdpZGdldCB7XG4gICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZUdyYXBoV2lkZ2V0KHsgdGl0bGUsIGxlZnQ6IG1ldHJpY3MgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBsYW1iZGFNZXRyaWMoXG4gICAgICAgIGxhbWJkYTogTGFtYmRhV2lkZ2V0UHJvcHMsXG4gICAgICAgIGxhYmVsOiBzdHJpbmcsXG4gICAgICAgIG1ldHJpY05hbWU6IHN0cmluZyxcbiAgICAgICAgc3RhdGlzdGljOiBjdy5TdGF0aXN0aWMsXG4gICAgICAgIHVuaXQ/OiBjdy5Vbml0XG4gICAgKTogY3cuSU1ldHJpYyB7XG4gICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZUdyYXBoTWV0cmljKHtcbiAgICAgICAgICAgIGxhYmVsLFxuICAgICAgICAgICAgbWV0cmljTmFtZSxcbiAgICAgICAgICAgIG5hbWVzcGFjZTogJ0FXUy9MYW1iZGEnLFxuICAgICAgICAgICAgc3RhdGlzdGljLFxuICAgICAgICAgICAgdW5pdCxcbiAgICAgICAgICAgIGRpbWVuc2lvbnM6IHsgRnVuY3Rpb25OYW1lOiBsYW1iZGEuZnVuY3Rpb25OYW1lIH0sXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgY3JlYXRlRHluYW1vRGJXaWRnZXRzKGR5bmFtb0RiVGFibGU6IER5bmFtb0RiV2lkZ2V0UHJvcHMpOiBjdy5JV2lkZ2V0W10ge1xuICAgICAgICBjb25zdCBwcmVmaXggPSBkeW5hbW9EYlRhYmxlLmZyaWVuZGx5VGFibGVOYW1lID8/IGR5bmFtb0RiVGFibGUudGFibGVOYW1lO1xuICAgICAgICByZXR1cm4gW1xuICAgICAgICAgICAgdGhpcy5kZGJXaWRnZXQoYCR7cHJlZml4fSAtIENhcGFjaXR5YCwgW1xuICAgICAgICAgICAgICAgIHRoaXMuZGRiTWV0cmljKFxuICAgICAgICAgICAgICAgICAgICBkeW5hbW9EYlRhYmxlLnRhYmxlTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgJ1Byb3Zpc2lvbmVkIFJlYWQnLFxuICAgICAgICAgICAgICAgICAgICAnUHJvdmlzaW9uZWRSZWFkQ2FwYWNpdHlVbml0cycsXG4gICAgICAgICAgICAgICAgICAgIGN3LlN0YXRpc3RpYy5BVkVSQUdFLFxuICAgICAgICAgICAgICAgICAgICBjdy5Vbml0LkNPVU5UXG4gICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICB0aGlzLmRkYk1ldHJpYyhcbiAgICAgICAgICAgICAgICAgICAgZHluYW1vRGJUYWJsZS50YWJsZU5hbWUsXG4gICAgICAgICAgICAgICAgICAgICdDb25zdW1lZCBSZWFkJyxcbiAgICAgICAgICAgICAgICAgICAgJ0NvbnN1bWVkUmVhZENhcGFjaXR5VW5pdHMnLFxuICAgICAgICAgICAgICAgICAgICBjdy5TdGF0aXN0aWMuQVZFUkFHRSxcbiAgICAgICAgICAgICAgICAgICAgY3cuVW5pdC5DT1VOVFxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgdGhpcy5kZGJNZXRyaWMoXG4gICAgICAgICAgICAgICAgICAgIGR5bmFtb0RiVGFibGUudGFibGVOYW1lLFxuICAgICAgICAgICAgICAgICAgICAnUHJvdmlzaW9uZWQgUmVhZCcsXG4gICAgICAgICAgICAgICAgICAgICdQcm92aXNpb25lZFdyaXRlQ2FwYWNpdHlVbml0cycsXG4gICAgICAgICAgICAgICAgICAgIGN3LlN0YXRpc3RpYy5BVkVSQUdFLFxuICAgICAgICAgICAgICAgICAgICBjdy5Vbml0LkNPVU5UXG4gICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICB0aGlzLmRkYk1ldHJpYyhcbiAgICAgICAgICAgICAgICAgICAgZHluYW1vRGJUYWJsZS50YWJsZU5hbWUsXG4gICAgICAgICAgICAgICAgICAgICdDb25zdW1lZCBSZWFkJyxcbiAgICAgICAgICAgICAgICAgICAgJ0NvbnN1bWVkV3JpdGVDYXBhY2l0eVVuaXRzJyxcbiAgICAgICAgICAgICAgICAgICAgY3cuU3RhdGlzdGljLkFWRVJBR0UsXG4gICAgICAgICAgICAgICAgICAgIGN3LlVuaXQuQ09VTlRcbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgXSksXG4gICAgICAgICAgICB0aGlzLmRkYldpZGdldChgJHtwcmVmaXh9IC0gTGF0ZW5jeWAsIFtcbiAgICAgICAgICAgICAgICB0aGlzLmRkYk1ldHJpYyhcbiAgICAgICAgICAgICAgICAgICAgZHluYW1vRGJUYWJsZS50YWJsZU5hbWUsXG4gICAgICAgICAgICAgICAgICAgICdHZXQgTGF0ZW5jeScsXG4gICAgICAgICAgICAgICAgICAgICdTdWNjZXNzZnVsUmVxdWVzdExhdGVuY3knLFxuICAgICAgICAgICAgICAgICAgICBjdy5TdGF0aXN0aWMuQVZFUkFHRSxcbiAgICAgICAgICAgICAgICAgICAgY3cuVW5pdC5NSUxMSVNFQ09ORFMsXG4gICAgICAgICAgICAgICAgICAgIHsgT3BlcmF0aW9uOiAnR2V0SXRlbScgfVxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgdGhpcy5kZGJNZXRyaWMoXG4gICAgICAgICAgICAgICAgICAgIGR5bmFtb0RiVGFibGUudGFibGVOYW1lLFxuICAgICAgICAgICAgICAgICAgICAnUHV0IExhdGVuY3knLFxuICAgICAgICAgICAgICAgICAgICAnU3VjY2Vzc2Z1bFJlcXVlc3RMYXRlbmN5JyxcbiAgICAgICAgICAgICAgICAgICAgY3cuU3RhdGlzdGljLkFWRVJBR0UsXG4gICAgICAgICAgICAgICAgICAgIGN3LlVuaXQuTUlMTElTRUNPTkRTLFxuICAgICAgICAgICAgICAgICAgICB7IE9wZXJhdGlvbjogJ1B1dEl0ZW0nIH1cbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgIHRoaXMuZGRiTWV0cmljKFxuICAgICAgICAgICAgICAgICAgICBkeW5hbW9EYlRhYmxlLnRhYmxlTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgJ1NjYW4gTGF0ZW5jeScsXG4gICAgICAgICAgICAgICAgICAgICdTdWNjZXNzZnVsUmVxdWVzdExhdGVuY3knLFxuICAgICAgICAgICAgICAgICAgICBjdy5TdGF0aXN0aWMuQVZFUkFHRSxcbiAgICAgICAgICAgICAgICAgICAgY3cuVW5pdC5NSUxMSVNFQ09ORFMsXG4gICAgICAgICAgICAgICAgICAgIHsgT3BlcmF0aW9uOiAnU2NhbicgfVxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgdGhpcy5kZGJNZXRyaWMoXG4gICAgICAgICAgICAgICAgICAgIGR5bmFtb0RiVGFibGUudGFibGVOYW1lLFxuICAgICAgICAgICAgICAgICAgICAnUXVlcnkgTGF0ZW5jeScsXG4gICAgICAgICAgICAgICAgICAgICdTdWNjZXNzZnVsUmVxdWVzdExhdGVuY3knLFxuICAgICAgICAgICAgICAgICAgICBjdy5TdGF0aXN0aWMuQVZFUkFHRSxcbiAgICAgICAgICAgICAgICAgICAgY3cuVW5pdC5NSUxMSVNFQ09ORFMsXG4gICAgICAgICAgICAgICAgICAgIHsgT3BlcmF0aW9uOiAnUXVlcnknIH1cbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgXSksXG4gICAgICAgICAgICB0aGlzLmRkYldpZGdldChgJHtwcmVmaXh9IC0gRXJyb3JzYCwgW1xuICAgICAgICAgICAgICAgIHRoaXMuZGRiTWV0cmljKFxuICAgICAgICAgICAgICAgICAgICBkeW5hbW9EYlRhYmxlLnRhYmxlTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgJ0dldCcsXG4gICAgICAgICAgICAgICAgICAgICdTeXN0ZW1FcnJvcnMnLFxuICAgICAgICAgICAgICAgICAgICBjdy5TdGF0aXN0aWMuU1VNLFxuICAgICAgICAgICAgICAgICAgICBjdy5Vbml0LkNPVU5ULFxuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICBPcGVyYXRpb246ICdHZXRJdGVtJyxcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgdGhpcy5kZGJNZXRyaWMoXG4gICAgICAgICAgICAgICAgICAgIGR5bmFtb0RiVGFibGUudGFibGVOYW1lLFxuICAgICAgICAgICAgICAgICAgICAnQmF0Y2ggR2V0JyxcbiAgICAgICAgICAgICAgICAgICAgJ1N5c3RlbUVycm9ycycsXG4gICAgICAgICAgICAgICAgICAgIGN3LlN0YXRpc3RpYy5TVU0sXG4gICAgICAgICAgICAgICAgICAgIGN3LlVuaXQuQ09VTlQsXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIE9wZXJhdGlvbjogJ0JhdGNoR2V0SXRlbScsXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgIHRoaXMuZGRiTWV0cmljKFxuICAgICAgICAgICAgICAgICAgICBkeW5hbW9EYlRhYmxlLnRhYmxlTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgJ1NjYW4nLFxuICAgICAgICAgICAgICAgICAgICAnU3lzdGVtRXJyb3JzJyxcbiAgICAgICAgICAgICAgICAgICAgY3cuU3RhdGlzdGljLlNVTSxcbiAgICAgICAgICAgICAgICAgICAgY3cuVW5pdC5DT1VOVCxcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgT3BlcmF0aW9uOiAnU2NhbicsXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgIHRoaXMuZGRiTWV0cmljKFxuICAgICAgICAgICAgICAgICAgICBkeW5hbW9EYlRhYmxlLnRhYmxlTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgJ1F1ZXJ5JyxcbiAgICAgICAgICAgICAgICAgICAgJ1N5c3RlbUVycm9ycycsXG4gICAgICAgICAgICAgICAgICAgIGN3LlN0YXRpc3RpYy5TVU0sXG4gICAgICAgICAgICAgICAgICAgIGN3LlVuaXQuQ09VTlQsXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIE9wZXJhdGlvbjogJ1F1ZXJ5JyxcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgdGhpcy5kZGJNZXRyaWMoXG4gICAgICAgICAgICAgICAgICAgIGR5bmFtb0RiVGFibGUudGFibGVOYW1lLFxuICAgICAgICAgICAgICAgICAgICAnUHV0JyxcbiAgICAgICAgICAgICAgICAgICAgJ1N5c3RlbUVycm9ycycsXG4gICAgICAgICAgICAgICAgICAgIGN3LlN0YXRpc3RpYy5TVU0sXG4gICAgICAgICAgICAgICAgICAgIGN3LlVuaXQuQ09VTlQsXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIE9wZXJhdGlvbjogJ1B1dEl0ZW0nLFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICB0aGlzLmRkYk1ldHJpYyhcbiAgICAgICAgICAgICAgICAgICAgZHluYW1vRGJUYWJsZS50YWJsZU5hbWUsXG4gICAgICAgICAgICAgICAgICAgICdCYXRjaCBXcml0ZScsXG4gICAgICAgICAgICAgICAgICAgICdTeXN0ZW1FcnJvcnMnLFxuICAgICAgICAgICAgICAgICAgICBjdy5TdGF0aXN0aWMuU1VNLFxuICAgICAgICAgICAgICAgICAgICBjdy5Vbml0LkNPVU5ULFxuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICBPcGVyYXRpb246ICdCYXRjaFdyaXRlSXRlbScsXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgIHRoaXMuZGRiTWV0cmljKFxuICAgICAgICAgICAgICAgICAgICBkeW5hbW9EYlRhYmxlLnRhYmxlTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgJ1VwZGF0ZScsXG4gICAgICAgICAgICAgICAgICAgICdTeXN0ZW1FcnJvcnMnLFxuICAgICAgICAgICAgICAgICAgICBjdy5TdGF0aXN0aWMuU1VNLFxuICAgICAgICAgICAgICAgICAgICBjdy5Vbml0LkNPVU5ULFxuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICBPcGVyYXRpb246ICdVcGRhdGVJdGVtJyxcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgdGhpcy5kZGJNZXRyaWMoXG4gICAgICAgICAgICAgICAgICAgIGR5bmFtb0RiVGFibGUudGFibGVOYW1lLFxuICAgICAgICAgICAgICAgICAgICAnRGVsZXRlJyxcbiAgICAgICAgICAgICAgICAgICAgJ1N5c3RlbUVycm9ycycsXG4gICAgICAgICAgICAgICAgICAgIGN3LlN0YXRpc3RpYy5TVU0sXG4gICAgICAgICAgICAgICAgICAgIGN3LlVuaXQuQ09VTlQsXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIE9wZXJhdGlvbjogJ0RlbGV0ZUl0ZW0nLFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIF0pLFxuICAgICAgICAgICAgdGhpcy5kZGJXaWRnZXQoYCR7cHJlZml4fSAtIFRocm90dGxlZCBSZXF1ZXN0c2AsIFtcbiAgICAgICAgICAgICAgICB0aGlzLmRkYk1ldHJpYyhcbiAgICAgICAgICAgICAgICAgICAgZHluYW1vRGJUYWJsZS50YWJsZU5hbWUsXG4gICAgICAgICAgICAgICAgICAgICdUaHJvdHRsZWQgUmVxdWVzdHMnLFxuICAgICAgICAgICAgICAgICAgICAnVGhyb3R0bGVkUmVxdWVzdHMnLFxuICAgICAgICAgICAgICAgICAgICBjdy5TdGF0aXN0aWMuU1VNLFxuICAgICAgICAgICAgICAgICAgICBjdy5Vbml0LkNPVU5UXG4gICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIF0pLFxuICAgICAgICBdO1xuICAgIH1cblxuICAgIHByaXZhdGUgZGRiTWV0cmljKFxuICAgICAgICB0YWJsZU5hbWU6IHN0cmluZyxcbiAgICAgICAgbGFiZWw6IHN0cmluZyxcbiAgICAgICAgbWV0cmljTmFtZTogc3RyaW5nLFxuICAgICAgICBzdGF0aXN0aWM6IGN3LlN0YXRpc3RpYyxcbiAgICAgICAgdW5pdD86IGN3LlVuaXQsXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gICAgICAgIGRpbWVuc2lvbnM/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+XG4gICAgKTogY3cuSU1ldHJpYyB7XG4gICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZUdyYXBoTWV0cmljKHtcbiAgICAgICAgICAgIGxhYmVsLFxuICAgICAgICAgICAgbWV0cmljTmFtZSxcbiAgICAgICAgICAgIHN0YXRpc3RpYyxcbiAgICAgICAgICAgIG5hbWVzcGFjZTogJ0FXUy9EeW5hbW9EQicsXG4gICAgICAgICAgICB1bml0LFxuICAgICAgICAgICAgZGltZW5zaW9uczogeyAuLi5kaW1lbnNpb25zLCBUYWJsZU5hbWU6IHRhYmxlTmFtZSB9LFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGRkYldpZGdldCh0aXRsZTogc3RyaW5nLCBtZXRyaWNzOiBjdy5JTWV0cmljW10pOiBjdy5JV2lkZ2V0IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlR3JhcGhXaWRnZXQoeyB0aXRsZSwgbGVmdDogbWV0cmljcyB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFwaUdhdGV3YXlXaWRnZXQoXG4gICAgICAgIHRpdGxlOiBzdHJpbmcsXG4gICAgICAgIGxlZnRNZXRyaWNzOiBjdy5JTWV0cmljW10sXG4gICAgICAgIHJpZ2h0TWV0cmljcz86IGN3LklNZXRyaWNbXSxcbiAgICAgICAgbGVmdExhYmVsPzogc3RyaW5nLFxuICAgICAgICByaWdodExhYmVsPzogc3RyaW5nXG4gICAgKTogY3cuSVdpZGdldCB7XG4gICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZUdyYXBoV2lkZ2V0KHtcbiAgICAgICAgICAgIHRpdGxlLFxuICAgICAgICAgICAgbGVmdDogbGVmdE1ldHJpY3MsXG4gICAgICAgICAgICByaWdodDogcmlnaHRNZXRyaWNzLFxuICAgICAgICAgICAgbGVmdFlBeGlzOiB7IGxhYmVsOiBsZWZ0TGFiZWwgfSxcbiAgICAgICAgICAgIHJpZ2h0WUF4aXM6IHsgbGFiZWw6IHJpZ2h0TGFiZWwgfSxcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhcGlHYXRld2F5TWV0cmljKFxuICAgICAgICBhcGlOYW1lOiBzdHJpbmcsXG4gICAgICAgIGxhYmVsOiBzdHJpbmcsXG4gICAgICAgIG1ldHJpY05hbWU6IHN0cmluZyxcbiAgICAgICAgc3RhdGlzdGljOiBjdy5TdGF0aXN0aWMsXG4gICAgICAgIHVuaXQ/OiBjdy5Vbml0LFxuICAgICAgICBtZXRob2Q/OiBzdHJpbmcsXG4gICAgICAgIHJlc291cmNlPzogc3RyaW5nLFxuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICAgICAgICBkaW1lbnNpb25zPzogUmVjb3JkPHN0cmluZywgYW55PlxuICAgICk6IGN3LklNZXRyaWMge1xuICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGVHcmFwaE1ldHJpYyh7XG4gICAgICAgICAgICBsYWJlbCxcbiAgICAgICAgICAgIG1ldHJpY05hbWUsXG4gICAgICAgICAgICBzdGF0aXN0aWMsXG4gICAgICAgICAgICB1bml0LFxuICAgICAgICAgICAgbmFtZXNwYWNlOiAnQVdTL0FwaUdhdGV3YXknLFxuICAgICAgICAgICAgZGltZW5zaW9uczoge1xuICAgICAgICAgICAgICAgIC4uLmRpbWVuc2lvbnMsXG4gICAgICAgICAgICAgICAgQXBpTmFtZTogYXBpTmFtZSxcbiAgICAgICAgICAgICAgICBTdGFnZTogJ3Byb2QnLFxuICAgICAgICAgICAgICAgIE1ldGhvZDogbWV0aG9kLFxuICAgICAgICAgICAgICAgIFJlc291cmNlOiByZXNvdXJjZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgY3JlYXRlR3JhcGhXaWRnZXQocHJvcHM6IGN3LkdyYXBoV2lkZ2V0UHJvcHMpOiBjdy5HcmFwaFdpZGdldCB7XG4gICAgICAgIHJldHVybiBuZXcgY3cuR3JhcGhXaWRnZXQoeyBoZWlnaHQ6IDYsIHdpZHRoOiA2LCBsaXZlRGF0YTogdHJ1ZSwgLi4ucHJvcHMgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjcmVhdGVHcmFwaE1ldHJpYyhwcm9wczogY3cuTWV0cmljUHJvcHMpOiBjdy5JTWV0cmljIHtcbiAgICAgICAgcmV0dXJuIG5ldyBjdy5NZXRyaWMocHJvcHMpO1xuICAgIH1cbn1cbiJdfQ==