"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.AgsServiceDashboard = void 0;
/*
  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
  
  Licensed under the Apache License, Version 2.0 (the "License").
  You may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  
      http://www.apache.org/licenses/LICENSE-2.0
  
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
*/
const cdk = require("aws-cdk-lib");
const cw = require("aws-cdk-lib/aws-cloudwatch");
const constructs_1 = require("constructs");
class AgsServiceDashboard extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        this.keyMetrics = new Map();
        const dashboard = new cw.Dashboard(this, `${props.serviceName}-dashboard`, {
            dashboardName: props.dashboardName,
        });
        // canary and api gateway widgets
        if (props.apiGateway) {
            dashboard.addWidgets(...this.createApiWidgets(props.apiGateway, props.canaryName));
        }
        // lambda widgets
        dashboard.addWidgets(...props.lambdas
            .map((lambda) => this.createLambdaWidgets(lambda))
            .reduce((previous, current) => previous.concat(current)));
        // dynamo db
        if (props.dynamoDbTables && props.dynamoDbTables.length > 0) {
            dashboard.addWidgets(...props.dynamoDbTables
                .map((table) => this.createDynamoDbWidgets(table))
                .reduce((previous, current) => previous.concat(current)));
        }
        if (props.additionalWidgets && props.additionalWidgets.length > 0) {
            dashboard.addWidgets(...props.additionalWidgets);
        }
        this.dashboard = dashboard;
    }
    createLambdaWidgets(lambda) {
        var _a;
        const prefix = (_a = lambda.friendlyName) !== null && _a !== void 0 ? _a : lambda.functionName;
        const successRateMetrics = this.createSuccessRateMetrics(lambda);
        const maximumDurationMetrics = this.lambdaMetric(lambda, 'Maximum', 'Duration', cw.Statistic.MAXIMUM, cw.Unit.MILLISECONDS);
        const averageDurationMetrics = this.lambdaMetric(lambda, 'Average', 'Duration', cw.Statistic.AVERAGE, cw.Unit.MILLISECONDS);
        const minDurationMetrics = this.lambdaMetric(lambda, 'Minimum', 'Duration', cw.Statistic.MINIMUM, cw.Unit.MILLISECONDS);
        this.keyMetrics.set('SUCESS_RATE', successRateMetrics);
        return [
            this.lambdaWidget(`${prefix} - Duration`, [
                minDurationMetrics,
                maximumDurationMetrics,
                averageDurationMetrics,
            ]),
            this.createGraphWidget({
                title: `${prefix} -  Success Rate`,
                left: [successRateMetrics],
                leftYAxis: { max: 100, min: 0, label: 'Percent', showUnits: false },
            }),
        ];
    }
    createSuccessRateMetrics(lambda) {
        const invocations = this.lambdaMetric(lambda, 'Invocations', 'Invocations', cw.Statistic.SUM, cw.Unit.COUNT);
        const errorCount = this.lambdaMetric(lambda, 'Error', 'Errors', cw.Statistic.SUM, cw.Unit.COUNT);
        const successRateMetrics = new cw.MathExpression({
            expression: '100 - 100 * errors / MAX([errors, invocations])',
            usingMetrics: {
                errors: errorCount,
                invocations: invocations,
            },
            period: cdk.Duration.minutes(5),
            label: 'Success rate',
        });
        return successRateMetrics;
    }
    createApiWidgets(apg, canaryName) {
        const metrics = [];
        if (canaryName) {
            metrics.push(this.apiGatewayWidget('Canary Status', [
                this.createGraphMetric({
                    metricName: 'SuccessPercent',
                    namespace: 'CloudWatchSynthetics',
                    label: 'Canary Status',
                    statistic: cw.Statistic.AVERAGE,
                    unit: cw.Unit.PERCENT,
                    dimensionsMap: { CanaryName: canaryName },
                }),
            ]));
        }
        metrics.push(this.apiGatewayWidget('API Invocation', apg.endpoints.map((api) => {
            var _a;
            return this.apiGatewayMetric(apg.apiName, (_a = api.friendlyName) !== null && _a !== void 0 ? _a : `${api.method} ${api.resource}`, 'Count', cw.Statistic.SUM, cw.Unit.COUNT, api.method, api.resource);
        })), this.apiGatewayWidget('API Latency', apg.endpoints.map((api) => {
            var _a;
            return this.apiGatewayMetric(apg.apiName, (_a = api.friendlyName) !== null && _a !== void 0 ? _a : `${api.method} ${api.resource}`, 'Latency', cw.Statistic.AVERAGE, cw.Unit.MILLISECONDS, api.method, api.resource);
        })), this.apiGatewayWidget('API Errors', apg.endpoints.map((api) => {
            var _a;
            return this.apiGatewayMetric(apg.apiName, (_a = api.friendlyName) !== null && _a !== void 0 ? _a : `${api.method} ${api.resource}`, '4XXError', cw.Statistic.SUM, cw.Unit.COUNT, api.method, api.resource);
        }), apg.endpoints.map((api) => {
            var _a;
            return this.apiGatewayMetric(apg.apiName, (_a = api.friendlyName) !== null && _a !== void 0 ? _a : `${api.method} ${api.resource}`, '5XXError', cw.Statistic.SUM, cw.Unit.COUNT, api.method, api.resource);
        }), '4XX Errors', '5XX Errors'));
        return metrics;
    }
    lambdaWidget(title, metrics) {
        return this.createGraphWidget({ title, left: metrics });
    }
    lambdaMetric(lambda, label, metricName, statistic, unit) {
        return this.createGraphMetric({
            label,
            metricName,
            namespace: 'AWS/Lambda',
            statistic,
            unit,
            dimensionsMap: { FunctionName: lambda.functionName },
        });
    }
    createDynamoDbWidgets(dynamoDbTable) {
        var _a;
        const prefix = (_a = dynamoDbTable.friendlyTableName) !== null && _a !== void 0 ? _a : dynamoDbTable.tableName;
        return [
            this.ddbWidget(`${prefix} - Capacity`, [
                this.ddbMetric(dynamoDbTable.tableName, 'Provisioned Read', 'ProvisionedReadCapacityUnits', cw.Statistic.AVERAGE, cw.Unit.COUNT),
                this.ddbMetric(dynamoDbTable.tableName, 'Consumed Read', 'ConsumedReadCapacityUnits', cw.Statistic.AVERAGE, cw.Unit.COUNT),
                this.ddbMetric(dynamoDbTable.tableName, 'Provisioned Read', 'ProvisionedWriteCapacityUnits', cw.Statistic.AVERAGE, cw.Unit.COUNT),
                this.ddbMetric(dynamoDbTable.tableName, 'Consumed Read', 'ConsumedWriteCapacityUnits', cw.Statistic.AVERAGE, cw.Unit.COUNT),
            ]),
            this.ddbWidget(`${prefix} - Latency`, [
                this.ddbMetric(dynamoDbTable.tableName, 'Get Latency', 'SuccessfulRequestLatency', cw.Statistic.AVERAGE, cw.Unit.MILLISECONDS, { Operation: 'GetItem' }),
                this.ddbMetric(dynamoDbTable.tableName, 'Put Latency', 'SuccessfulRequestLatency', cw.Statistic.AVERAGE, cw.Unit.MILLISECONDS, { Operation: 'PutItem' }),
                this.ddbMetric(dynamoDbTable.tableName, 'Scan Latency', 'SuccessfulRequestLatency', cw.Statistic.AVERAGE, cw.Unit.MILLISECONDS, { Operation: 'Scan' }),
                this.ddbMetric(dynamoDbTable.tableName, 'Query Latency', 'SuccessfulRequestLatency', cw.Statistic.AVERAGE, cw.Unit.MILLISECONDS, { Operation: 'Query' }),
            ]),
            this.ddbWidget(`${prefix} - Errors`, [
                this.ddbMetric(dynamoDbTable.tableName, 'Get', 'SystemErrors', cw.Statistic.SUM, cw.Unit.COUNT, {
                    Operation: 'GetItem',
                }),
                this.ddbMetric(dynamoDbTable.tableName, 'Batch Get', 'SystemErrors', cw.Statistic.SUM, cw.Unit.COUNT, {
                    Operation: 'BatchGetItem',
                }),
                this.ddbMetric(dynamoDbTable.tableName, 'Scan', 'SystemErrors', cw.Statistic.SUM, cw.Unit.COUNT, {
                    Operation: 'Scan',
                }),
                this.ddbMetric(dynamoDbTable.tableName, 'Query', 'SystemErrors', cw.Statistic.SUM, cw.Unit.COUNT, {
                    Operation: 'Query',
                }),
                this.ddbMetric(dynamoDbTable.tableName, 'Put', 'SystemErrors', cw.Statistic.SUM, cw.Unit.COUNT, {
                    Operation: 'PutItem',
                }),
                this.ddbMetric(dynamoDbTable.tableName, 'Batch Write', 'SystemErrors', cw.Statistic.SUM, cw.Unit.COUNT, {
                    Operation: 'BatchWriteItem',
                }),
                this.ddbMetric(dynamoDbTable.tableName, 'Update', 'SystemErrors', cw.Statistic.SUM, cw.Unit.COUNT, {
                    Operation: 'UpdateItem',
                }),
                this.ddbMetric(dynamoDbTable.tableName, 'Delete', 'SystemErrors', cw.Statistic.SUM, cw.Unit.COUNT, {
                    Operation: 'DeleteItem',
                }),
            ]),
            this.ddbWidget(`${prefix} - Throttled Requests`, [
                this.ddbMetric(dynamoDbTable.tableName, 'Throttled Requests', 'ThrottledRequests', cw.Statistic.SUM, cw.Unit.COUNT),
            ]),
        ];
    }
    ddbMetric(tableName, label, metricName, statistic, unit, 
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    dimensions) {
        return this.createGraphMetric({
            label,
            metricName,
            statistic,
            namespace: 'AWS/DynamoDB',
            unit,
            dimensionsMap: { ...dimensions, TableName: tableName },
        });
    }
    ddbWidget(title, metrics) {
        return this.createGraphWidget({ title, left: metrics });
    }
    apiGatewayWidget(title, leftMetrics, rightMetrics, leftLabel, rightLabel) {
        return this.createGraphWidget({
            title,
            left: leftMetrics,
            right: rightMetrics,
            leftYAxis: { label: leftLabel },
            rightYAxis: { label: rightLabel },
        });
    }
    apiGatewayMetric(apiName, label, metricName, statistic, unit, method, resource, 
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    dimensions) {
        return this.createGraphMetric({
            label,
            metricName,
            statistic,
            unit,
            namespace: 'AWS/ApiGateway',
            dimensionsMap: {
                ...dimensions,
                ApiName: apiName,
                Stage: 'prod',
                Method: method,
                Resource: resource,
            },
        });
    }
    createGraphWidget(props) {
        return new cw.GraphWidget({ height: 6, width: 6, liveData: true, ...props });
    }
    createGraphMetric(props) {
        return new cw.Metric(props);
    }
}
exports.AgsServiceDashboard = AgsServiceDashboard;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWdzLXNlcnZpY2UtZGFzaGJvYXJkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vbGliL2Fncy1zZXJ2aWNlLWRhc2hib2FyZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQTs7Ozs7Ozs7Ozs7Ozs7RUFjRTtBQUNGLG1DQUFtQztBQUNuQyxpREFBaUQ7QUFDakQsMkNBQXVDO0FBMkJ2QyxNQUFhLG1CQUFvQixTQUFRLHNCQUFTO0lBSTlDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBK0I7UUFDckUsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUNqQixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7UUFDNUIsTUFBTSxTQUFTLEdBQUcsSUFBSSxFQUFFLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxHQUFHLEtBQUssQ0FBQyxXQUFXLFlBQVksRUFBRTtZQUN2RSxhQUFhLEVBQUUsS0FBSyxDQUFDLGFBQWE7U0FDckMsQ0FBQyxDQUFDO1FBRUgsaUNBQWlDO1FBQ2pDLElBQUksS0FBSyxDQUFDLFVBQVUsRUFBRTtZQUNsQixTQUFTLENBQUMsVUFBVSxDQUNoQixHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FDL0QsQ0FBQztTQUNMO1FBRUQsaUJBQWlCO1FBQ2pCLFNBQVMsQ0FBQyxVQUFVLENBQ2hCLEdBQUcsS0FBSyxDQUFDLE9BQU87YUFDWCxHQUFHLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxNQUFNLENBQUMsQ0FBQzthQUNqRCxNQUFNLENBQUMsQ0FBQyxRQUFRLEVBQUUsT0FBTyxFQUFFLEVBQUUsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQy9ELENBQUM7UUFFRixZQUFZO1FBQ1osSUFBSSxLQUFLLENBQUMs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UUFBUSxFQUFFLFFBQVE7YUFDckI7U0FDSixDQUFDLENBQUM7SUFDUCxDQUFDO0lBRU8saUJBQWlCLENBQUMsS0FBMEI7UUFDaEQsT0FBTyxJQUFJLEVBQUUsQ0FBQyxXQUFXLENBQUMsRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxHQUFHLEtBQUssRUFBRSxDQUFDLENBQUM7SUFDakYsQ0FBQztJQUVPLGlCQUFpQixDQUFDLEtBQXFCO1FBQzNDLE9BQU8sSUFBSSxFQUFFLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ2hDLENBQUM7Q0FDSjtBQS9iRCxrREErYkMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBcbiAgQ29weXJpZ2h0IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gIFxuICBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpLlxuICBZb3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICBcbiAgICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICBcbiAgVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuKi9cbmltcG9ydCAqIGFzIGNkayBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgKiBhcyBjdyBmcm9tICdhd3MtY2RrLWxpYi9hd3MtY2xvdWR3YXRjaCc7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcblxuZXhwb3J0IGludGVyZmFjZSBBcGlHYXRld2F5V2lkZ2V0UHJvcHMge1xuICAgIGFwaU5hbWU6IHN0cmluZztcbiAgICBlbmRwb2ludHM6IHsgbWV0aG9kOiBzdHJpbmc7IHJlc291cmNlOiBzdHJpbmc7IGZyaWVuZGx5TmFtZT86IHN0cmluZyB9W107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgTGFtYmRhV2lkZ2V0UHJvcHMge1xuICAgIGZ1bmN0aW9uTmFtZTogc3RyaW5nO1xuICAgIGZyaWVuZGx5TmFtZT86IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBEeW5hbW9EYldpZGdldFByb3BzIHtcbiAgICB0YWJsZU5hbWU6IHN0cmluZztcbiAgICBmcmllbmRseVRhYmxlTmFtZT86IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBZ3NTZXJ2aWNlRGFzaGJvYXJkUHJvcHMge1xuICAgIGRhc2hib2FyZE5hbWU/OiBzdHJpbmc7XG4gICAgc2VydmljZU5hbWU6IHN0cmluZztcbiAgICBjYW5hcnlOYW1lPzogc3RyaW5nO1xuICAgIGxhbWJkYXM6IExhbWJkYVdpZGdldFByb3BzW107XG4gICAgYXBpR2F0ZXdheT86IEFwaUdhdGV3YXlXaWRnZXRQcm9wcztcbiAgICBkeW5hbW9EYlRhYmxlcz86IER5bmFtb0RiV2lkZ2V0UHJvcHNbXTtcbiAgICBhZGRpdGlvbmFsV2lkZ2V0cz86IGN3LklXaWRnZXRbXTtcbn1cblxuZXhwb3J0IGNsYXNzIEFnc1NlcnZpY2VEYXNoYm9hcmQgZXh0ZW5kcyBDb25zdHJ1Y3Qge1xuICAgIHB1YmxpYyByZWFkb25seSBkYXNoYm9hcmQ6IGN3LkRhc2hib2FyZDtcbiAgICBwdWJsaWMga2V5TWV0cmljczogTWFwPHN0cmluZywgY3cuSU1ldHJpYz47XG5cbiAgICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogQWdzU2VydmljZURhc2hib2FyZFByb3BzKSB7XG4gICAgICAgIHN1cGVyKHNjb3BlLCBpZCk7XG4gICAgICAgIHRoaXMua2V5TWV0cmljcyA9IG5ldyBNYXAoKTtcbiAgICAgICAgY29uc3QgZGFzaGJvYXJkID0gbmV3IGN3LkRhc2hib2FyZCh0aGlzLCBgJHtwcm9wcy5zZXJ2aWNlTmFtZX0tZGFzaGJvYXJkYCwge1xuICAgICAgICAgICAgZGFzaGJvYXJkTmFtZTogcHJvcHMuZGFzaGJvYXJkTmFtZSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gY2FuYXJ5IGFuZCBhcGkgZ2F0ZXdheSB3aWRnZXRzXG4gICAgICAgIGlmIChwcm9wcy5hcGlHYXRld2F5KSB7XG4gICAgICAgICAgICBkYXNoYm9hcmQuYWRkV2lkZ2V0cyhcbiAgICAgICAgICAgICAgICAuLi50aGlzLmNyZWF0ZUFwaVdpZGdldHMocHJvcHMuYXBpR2F0ZXdheSwgcHJvcHMuY2FuYXJ5TmFtZSlcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBsYW1iZGEgd2lkZ2V0c1xuICAgICAgICBkYXNoYm9hcmQuYWRkV2lkZ2V0cyhcbiAgICAgICAgICAgIC4uLnByb3BzLmxhbWJkYXNcbiAgICAgICAgICAgICAgICAubWFwKChsYW1iZGEpID0+IHRoaXMuY3JlYXRlTGFtYmRhV2lkZ2V0cyhsYW1iZGEpKVxuICAgICAgICAgICAgICAgIC5yZWR1Y2UoKHByZXZpb3VzLCBjdXJyZW50KSA9PiBwcmV2aW91cy5jb25jYXQoY3VycmVudCkpXG4gICAgICAgICk7XG5cbiAgICAgICAgLy8gZHluYW1vIGRiXG4gICAgICAgIGlmIChwcm9wcy5keW5hbW9EYlRhYmxlcyAmJiBwcm9wcy5keW5hbW9EYlRhYmxlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBkYXNoYm9hcmQuYWRkV2lkZ2V0cyhcbiAgICAgICAgICAgICAgICAuLi5wcm9wcy5keW5hbW9EYlRhYmxlc1xuICAgICAgICAgICAgICAgICAgICAubWFwKCh0YWJsZSkgPT4gdGhpcy5jcmVhdGVEeW5hbW9EYldpZGdldHModGFibGUpKVxuICAgICAgICAgICAgICAgICAgICAucmVkdWNlKChwcmV2aW91cywgY3VycmVudCkgPT4gcHJldmlvdXMuY29uY2F0KGN1cnJlbnQpKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChwcm9wcy5hZGRpdGlvbmFsV2lkZ2V0cyAmJiBwcm9wcy5hZGRpdGlvbmFsV2lkZ2V0cy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBkYXNoYm9hcmQuYWRkV2lkZ2V0cyguLi5wcm9wcy5hZGRpdGlvbmFsV2lkZ2V0cyk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5kYXNoYm9hcmQgPSBkYXNoYm9hcmQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjcmVhdGVMYW1iZGFXaWRnZXRzKGxhbWJkYTogTGFtYmRhV2lkZ2V0UHJvcHMpOiBjdy5JV2lkZ2V0W10ge1xuICAgICAgICBjb25zdCBwcmVmaXggPSBsYW1iZGEuZnJpZW5kbHlOYW1lID8/IGxhbWJkYS5mdW5jdGlvbk5hbWU7XG4gICAgICAgIGNvbnN0IHN1Y2Nlc3NSYXRlTWV0cmljcyA9IHRoaXMuY3JlYXRlU3VjY2Vzc1JhdGVNZXRyaWNzKGxhbWJkYSk7XG4gICAgICAgIGNvbnN0IG1heGltdW1EdXJhdGlvbk1ldHJpY3MgPSB0aGlzLmxhbWJkYU1ldHJpYyhcbiAgICAgICAgICAgIGxhbWJkYSxcbiAgICAgICAgICAgICdNYXhpbXVtJyxcbiAgICAgICAgICAgICdEdXJhdGlvbicsXG4gICAgICAgICAgICBjdy5TdGF0aXN0aWMuTUFYSU1VTSxcbiAgICAgICAgICAgIGN3LlVuaXQuTUlMTElTRUNPTkRTXG4gICAgICAgICk7XG4gICAgICAgIGNvbnN0IGF2ZXJhZ2VEdXJhdGlvbk1ldHJpY3MgPSB0aGlzLmxhbWJkYU1ldHJpYyhcbiAgICAgICAgICAgIGxhbWJkYSxcbiAgICAgICAgICAgICdBdmVyYWdlJyxcbiAgICAgICAgICAgICdEdXJhdGlvbicsXG4gICAgICAgICAgICBjdy5TdGF0aXN0aWMuQVZFUkFHRSxcbiAgICAgICAgICAgIGN3LlVuaXQuTUlMTElTRUNPTkRTXG4gICAgICAgICk7XG4gICAgICAgIGNvbnN0IG1pbkR1cmF0aW9uTWV0cmljcyA9IHRoaXMubGFtYmRhTWV0cmljKFxuICAgICAgICAgICAgbGFtYmRhLFxuICAgICAgICAgICAgJ01pbmltdW0nLFxuICAgICAgICAgICAgJ0R1cmF0aW9uJyxcbiAgICAgICAgICAgIGN3LlN0YXRpc3RpYy5NSU5JTVVNLFxuICAgICAgICAgICAgY3cuVW5pdC5NSUxMSVNFQ09ORFNcbiAgICAgICAgKTtcbiAgICAgICAgdGhpcy5rZXlNZXRyaWNzLnNldCgnU1VDRVNTX1JBVEUnLCBzdWNjZXNzUmF0ZU1ldHJpY3MpO1xuXG4gICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICB0aGlzLmxhbWJkYVdpZGdldChgJHtwcmVmaXh9IC0gRHVyYXRpb25gLCBbXG4gICAgICAgICAgICAgICAgbWluRHVyYXRpb25NZXRyaWNzLFxuICAgICAgICAgICAgICAgIG1heGltdW1EdXJhdGlvbk1ldHJpY3MsXG4gICAgICAgICAgICAgICAgYXZlcmFnZUR1cmF0aW9uTWV0cmljcyxcbiAgICAgICAgICAgIF0pLFxuICAgICAgICAgICAgdGhpcy5jcmVhdGVHcmFwaFdpZGdldCh7XG4gICAgICAgICAgICAgICAgdGl0bGU6IGAke3ByZWZpeH0gLSAgU3VjY2VzcyBSYXRlYCxcbiAgICAgICAgICAgICAgICBsZWZ0OiBbc3VjY2Vzc1JhdGVNZXRyaWNzXSxcbiAgICAgICAgICAgICAgICBsZWZ0WUF4aXM6IHsgbWF4OiAxMDAsIG1pbjogMCwgbGFiZWw6ICdQZXJjZW50Jywgc2hvd1VuaXRzOiBmYWxzZSB9LFxuICAgICAgICAgICAgfSksXG4gICAgICAgIF07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjcmVhdGVTdWNjZXNzUmF0ZU1ldHJpY3MobGFtYmRhOiBMYW1iZGFXaWRnZXRQcm9wcykge1xuICAgICAgICBjb25zdCBpbnZvY2F0aW9uczogY3cuSU1ldHJpYyA9IHRoaXMubGFtYmRhTWV0cmljKFxuICAgICAgICAgICAgbGFtYmRhLFxuICAgICAgICAgICAgJ0ludm9jYXRpb25zJyxcbiAgICAgICAgICAgICdJbnZvY2F0aW9ucycsXG4gICAgICAgICAgICBjdy5TdGF0aXN0aWMuU1VNLFxuICAgICAgICAgICAgY3cuVW5pdC5DT1VOVFxuICAgICAgICApO1xuXG4gICAgICAgIGNvbnN0IGVycm9yQ291bnQ6IGN3LklNZXRyaWMgPSB0aGlzLmxhbWJkYU1ldHJpYyhcbiAgICAgICAgICAgIGxhbWJkYSxcbiAgICAgICAgICAgICdFcnJvcicsXG4gICAgICAgICAgICAnRXJyb3JzJyxcbiAgICAgICAgICAgIGN3LlN0YXRpc3RpYy5TVU0sXG4gICAgICAgICAgICBjdy5Vbml0LkNPVU5UXG4gICAgICAgICk7XG5cbiAgICAgICAgY29uc3Qgc3VjY2Vzc1JhdGVNZXRyaWNzID0gbmV3IGN3Lk1hdGhFeHByZXNzaW9uKHtcbiAgICAgICAgICAgIGV4cHJlc3Npb246ICcxMDAgLSAxMDAgKiBlcnJvcnMgLyBNQVgoW2Vycm9ycywgaW52b2NhdGlvbnNdKScsXG4gICAgICAgICAgICB1c2luZ01ldHJpY3M6IHtcbiAgICAgICAgICAgICAgICBlcnJvcnM6IGVycm9yQ291bnQsXG4gICAgICAgICAgICAgICAgaW52b2NhdGlvbnM6IGludm9jYXRpb25zLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHBlcmlvZDogY2RrLkR1cmF0aW9uLm1pbnV0ZXMoNSksXG4gICAgICAgICAgICBsYWJlbDogJ1N1Y2Nlc3MgcmF0ZScsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBzdWNjZXNzUmF0ZU1ldHJpY3M7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjcmVhdGVBcGlXaWRnZXRzKFxuICAgICAgICBhcGc6IEFwaUdhdGV3YXlXaWRnZXRQcm9wcyxcbiAgICAgICAgY2FuYXJ5TmFtZT86IHN0cmluZ1xuICAgICk6IGN3LklXaWRnZXRbXSB7XG4gICAgICAgIGNvbnN0IG1ldHJpY3MgPSBbXTtcblxuICAgICAgICBpZiAoY2FuYXJ5TmFtZSkge1xuICAgICAgICAgICAgbWV0cmljcy5wdXNoKFxuICAgICAgICAgICAgICAgIHRoaXMuYXBpR2F0ZXdheVdpZGdldCgnQ2FuYXJ5IFN0YXR1cycsIFtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jcmVhdGVHcmFwaE1ldHJpYyh7XG4gICAgICAgICAgICAgICAgICAgICAgICBtZXRyaWNOYW1lOiAnU3VjY2Vzc1BlcmNlbnQnLFxuICAgICAgICAgICAgICAgICAgICAgICAgbmFtZXNwYWNlOiAnQ2xvdWRXYXRjaFN5bnRoZXRpY3MnLFxuICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6ICdDYW5hcnkgU3RhdHVzJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRpc3RpYzogY3cuU3RhdGlzdGljLkFWRVJBR0UsXG4gICAgICAgICAgICAgICAgICAgICAgICB1bml0OiBjdy5Vbml0LlBFUkNFTlQsXG4gICAgICAgICAgICAgICAgICAgICAgICBkaW1lbnNpb25zTWFwOiB7IENhbmFyeU5hbWU6IGNhbmFyeU5hbWUgfSxcbiAgICAgICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgXSlcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICBtZXRyaWNzLnB1c2goXG4gICAgICAgICAgICB0aGlzLmFwaUdhdGV3YXlXaWRnZXQoXG4gICAgICAgICAgICAgICAgJ0FQSSBJbnZvY2F0aW9uJyxcbiAgICAgICAgICAgICAgICBhcGcuZW5kcG9pbnRzLm1hcCgoYXBpKSA9PlxuICAgICAgICAgICAgICAgICAgICB0aGlzLmFwaUdhdGV3YXlNZXRyaWMoXG4gICAgICAgICAgICAgICAgICAgICAgICBhcGcuYXBpTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwaS5mcmllbmRseU5hbWUgPz8gYCR7YXBpLm1ldGhvZH0gJHthcGkucmVzb3VyY2V9YCxcbiAgICAgICAgICAgICAgICAgICAgICAgICdDb3VudCcsXG4gICAgICAgICAgICAgICAgICAgICAgICBjdy5TdGF0aXN0aWMuU1VNLFxuICAgICAgICAgICAgICAgICAgICAgICAgY3cuVW5pdC5DT1VOVCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwaS5tZXRob2QsXG4gICAgICAgICAgICAgICAgICAgICAgICBhcGkucmVzb3VyY2VcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICksXG4gICAgICAgICAgICB0aGlzLmFwaUdhdGV3YXlXaWRnZXQoXG4gICAgICAgICAgICAgICAgJ0FQSSBMYXRlbmN5JyxcbiAgICAgICAgICAgICAgICBhcGcuZW5kcG9pbnRzLm1hcCgoYXBpKSA9PlxuICAgICAgICAgICAgICAgICAgICB0aGlzLmFwaUdhdGV3YXlNZXRyaWMoXG4gICAgICAgICAgICAgICAgICAgICAgICBhcGcuYXBpTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwaS5mcmllbmRseU5hbWUgPz8gYCR7YXBpLm1ldGhvZH0gJHthcGkucmVzb3VyY2V9YCxcbiAgICAgICAgICAgICAgICAgICAgICAgICdMYXRlbmN5JyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGN3LlN0YXRpc3RpYy5BVkVSQUdFLFxuICAgICAgICAgICAgICAgICAgICAgICAgY3cuVW5pdC5NSUxMSVNFQ09ORFMsXG4gICAgICAgICAgICAgICAgICAgICAgICBhcGkubWV0aG9kLFxuICAgICAgICAgICAgICAgICAgICAgICAgYXBpLnJlc291cmNlXG4gICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICApLFxuICAgICAgICAgICAgdGhpcy5hcGlHYXRld2F5V2lkZ2V0KFxuICAgICAgICAgICAgICAgICdBUEkgRXJyb3JzJyxcbiAgICAgICAgICAgICAgICBhcGcuZW5kcG9pbnRzLm1hcCgoYXBpKSA9PlxuICAgICAgICAgICAgICAgICAgICB0aGlzLmFwaUdhdGV3YXlNZXRyaWMoXG4gICAgICAgICAgICAgICAgICAgICAgICBhcGcuYXBpTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwaS5mcmllbmRseU5hbWUgPz8gYCR7YXBpLm1ldGhvZH0gJHthcGkucmVzb3VyY2V9YCxcbiAgICAgICAgICAgICAgICAgICAgICAgICc0WFhFcnJvcicsXG4gICAgICAgICAgICAgICAgICAgICAgICBjdy5TdGF0aXN0aWMuU1VNLFxuICAgICAgICAgICAgICAgICAgICAgICAgY3cuVW5pdC5DT1VOVCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwaS5tZXRob2QsXG4gICAgICAgICAgICAgICAgICAgICAgICBhcGkucmVzb3VyY2VcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgYXBnLmVuZHBvaW50cy5tYXAoKGFwaSkgPT5cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcGlHYXRld2F5TWV0cmljKFxuICAgICAgICAgICAgICAgICAgICAgICAgYXBnLmFwaU5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICBhcGkuZnJpZW5kbHlOYW1lID8/IGAke2FwaS5tZXRob2R9ICR7YXBpLnJlc291cmNlfWAsXG4gICAgICAgICAgICAgICAgICAgICAgICAnNVhYRXJyb3InLFxuICAgICAgICAgICAgICAgICAgICAgICAgY3cuU3RhdGlzdGljLlNVTSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGN3LlVuaXQuQ09VTlQsXG4gICAgICAgICAgICAgICAgICAgICAgICBhcGkubWV0aG9kLFxuICAgICAgICAgICAgICAgICAgICAgICAgYXBpLnJlc291cmNlXG4gICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICc0WFggRXJyb3JzJyxcbiAgICAgICAgICAgICAgICAnNVhYIEVycm9ycydcbiAgICAgICAgICAgIClcbiAgICAgICAgKTtcblxuICAgICAgICByZXR1cm4gbWV0cmljcztcbiAgICB9XG5cbiAgICBwcml2YXRlIGxhbWJkYVdpZGdldCh0aXRsZTogc3RyaW5nLCBtZXRyaWNzOiBjdy5JTWV0cmljW10pOiBjdy5JV2lkZ2V0IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlR3JhcGhXaWRnZXQoeyB0aXRsZSwgbGVmdDogbWV0cmljcyB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGxhbWJkYU1ldHJpYyhcbiAgICAgICAgbGFtYmRhOiBMYW1iZGFXaWRnZXRQcm9wcyxcbiAgICAgICAgbGFiZWw6IHN0cmluZyxcbiAgICAgICAgbWV0cmljTmFtZTogc3RyaW5nLFxuICAgICAgICBzdGF0aXN0aWM6IGN3LlN0YXRpc3RpYyxcbiAgICAgICAgdW5pdD86IGN3LlVuaXRcbiAgICApOiBjdy5JTWV0cmljIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlR3JhcGhNZXRyaWMoe1xuICAgICAgICAgICAgbGFiZWwsXG4gICAgICAgICAgICBtZXRyaWNOYW1lLFxuICAgICAgICAgICAgbmFtZXNwYWNlOiAnQVdTL0xhbWJkYScsXG4gICAgICAgICAgICBzdGF0aXN0aWMsXG4gICAgICAgICAgICB1bml0LFxuICAgICAgICAgICAgZGltZW5zaW9uc01hcDogeyBGdW5jdGlvbk5hbWU6IGxhbWJkYS5mdW5jdGlvbk5hbWUgfSxcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjcmVhdGVEeW5hbW9EYldpZGdldHMoZHluYW1vRGJUYWJsZTogRHluYW1vRGJXaWRnZXRQcm9wcyk6IGN3LklXaWRnZXRbXSB7XG4gICAgICAgIGNvbnN0IHByZWZpeCA9IGR5bmFtb0RiVGFibGUuZnJpZW5kbHlUYWJsZU5hbWUgPz8gZHluYW1vRGJUYWJsZS50YWJsZU5hbWU7XG4gICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICB0aGlzLmRkYldpZGdldChgJHtwcmVmaXh9IC0gQ2FwYWNpdHlgLCBbXG4gICAgICAgICAgICAgICAgdGhpcy5kZGJNZXRyaWMoXG4gICAgICAgICAgICAgICAgICAgIGR5bmFtb0RiVGFibGUudGFibGVOYW1lLFxuICAgICAgICAgICAgICAgICAgICAnUHJvdmlzaW9uZWQgUmVhZCcsXG4gICAgICAgICAgICAgICAgICAgICdQcm92aXNpb25lZFJlYWRDYXBhY2l0eVVuaXRzJyxcbiAgICAgICAgICAgICAgICAgICAgY3cuU3RhdGlzdGljLkFWRVJBR0UsXG4gICAgICAgICAgICAgICAgICAgIGN3LlVuaXQuQ09VTlRcbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgIHRoaXMuZGRiTWV0cmljKFxuICAgICAgICAgICAgICAgICAgICBkeW5hbW9EYlRhYmxlLnRhYmxlTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgJ0NvbnN1bWVkIFJlYWQnLFxuICAgICAgICAgICAgICAgICAgICAnQ29uc3VtZWRSZWFkQ2FwYWNpdHlVbml0cycsXG4gICAgICAgICAgICAgICAgICAgIGN3LlN0YXRpc3RpYy5BVkVSQUdFLFxuICAgICAgICAgICAgICAgICAgICBjdy5Vbml0LkNPVU5UXG4gICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICB0aGlzLmRkYk1ldHJpYyhcbiAgICAgICAgICAgICAgICAgICAgZHluYW1vRGJUYWJsZS50YWJsZU5hbWUsXG4gICAgICAgICAgICAgICAgICAgICdQcm92aXNpb25lZCBSZWFkJyxcbiAgICAgICAgICAgICAgICAgICAgJ1Byb3Zpc2lvbmVkV3JpdGVDYXBhY2l0eVVuaXRzJyxcbiAgICAgICAgICAgICAgICAgICAgY3cuU3RhdGlzdGljLkFWRVJBR0UsXG4gICAgICAgICAgICAgICAgICAgIGN3LlVuaXQuQ09VTlRcbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgIHRoaXMuZGRiTWV0cmljKFxuICAgICAgICAgICAgICAgICAgICBkeW5hbW9EYlRhYmxlLnRhYmxlTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgJ0NvbnN1bWVkIFJlYWQnLFxuICAgICAgICAgICAgICAgICAgICAnQ29uc3VtZWRXcml0ZUNhcGFjaXR5VW5pdHMnLFxuICAgICAgICAgICAgICAgICAgICBjdy5TdGF0aXN0aWMuQVZFUkFHRSxcbiAgICAgICAgICAgICAgICAgICAgY3cuVW5pdC5DT1VOVFxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICBdKSxcbiAgICAgICAgICAgIHRoaXMuZGRiV2lkZ2V0KGAke3ByZWZpeH0gLSBMYXRlbmN5YCwgW1xuICAgICAgICAgICAgICAgIHRoaXMuZGRiTWV0cmljKFxuICAgICAgICAgICAgICAgICAgICBkeW5hbW9EYlRhYmxlLnRhYmxlTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgJ0dldCBMYXRlbmN5JyxcbiAgICAgICAgICAgICAgICAgICAgJ1N1Y2Nlc3NmdWxSZXF1ZXN0TGF0ZW5jeScsXG4gICAgICAgICAgICAgICAgICAgIGN3LlN0YXRpc3RpYy5BVkVSQUdFLFxuICAgICAgICAgICAgICAgICAgICBjdy5Vbml0Lk1JTExJU0VDT05EUyxcbiAgICAgICAgICAgICAgICAgICAgeyBPcGVyYXRpb246ICdHZXRJdGVtJyB9XG4gICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICB0aGlzLmRkYk1ldHJpYyhcbiAgICAgICAgICAgICAgICAgICAgZHluYW1vRGJUYWJsZS50YWJsZU5hbWUsXG4gICAgICAgICAgICAgICAgICAgICdQdXQgTGF0ZW5jeScsXG4gICAgICAgICAgICAgICAgICAgICdTdWNjZXNzZnVsUmVxdWVzdExhdGVuY3knLFxuICAgICAgICAgICAgICAgICAgICBjdy5TdGF0aXN0aWMuQVZFUkFHRSxcbiAgICAgICAgICAgICAgICAgICAgY3cuVW5pdC5NSUxMSVNFQ09ORFMsXG4gICAgICAgICAgICAgICAgICAgIHsgT3BlcmF0aW9uOiAnUHV0SXRlbScgfVxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgdGhpcy5kZGJNZXRyaWMoXG4gICAgICAgICAgICAgICAgICAgIGR5bmFtb0RiVGFibGUudGFibGVOYW1lLFxuICAgICAgICAgICAgICAgICAgICAnU2NhbiBMYXRlbmN5JyxcbiAgICAgICAgICAgICAgICAgICAgJ1N1Y2Nlc3NmdWxSZXF1ZXN0TGF0ZW5jeScsXG4gICAgICAgICAgICAgICAgICAgIGN3LlN0YXRpc3RpYy5BVkVSQUdFLFxuICAgICAgICAgICAgICAgICAgICBjdy5Vbml0Lk1JTExJU0VDT05EUyxcbiAgICAgICAgICAgICAgICAgICAgeyBPcGVyYXRpb246ICdTY2FuJyB9XG4gICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICB0aGlzLmRkYk1ldHJpYyhcbiAgICAgICAgICAgICAgICAgICAgZHluYW1vRGJUYWJsZS50YWJsZU5hbWUsXG4gICAgICAgICAgICAgICAgICAgICdRdWVyeSBMYXRlbmN5JyxcbiAgICAgICAgICAgICAgICAgICAgJ1N1Y2Nlc3NmdWxSZXF1ZXN0TGF0ZW5jeScsXG4gICAgICAgICAgICAgICAgICAgIGN3LlN0YXRpc3RpYy5BVkVSQUdFLFxuICAgICAgICAgICAgICAgICAgICBjdy5Vbml0Lk1JTExJU0VDT05EUyxcbiAgICAgICAgICAgICAgICAgICAgeyBPcGVyYXRpb246ICdRdWVyeScgfVxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICBdKSxcbiAgICAgICAgICAgIHRoaXMuZGRiV2lkZ2V0KGAke3ByZWZpeH0gLSBFcnJvcnNgLCBbXG4gICAgICAgICAgICAgICAgdGhpcy5kZGJNZXRyaWMoXG4gICAgICAgICAgICAgICAgICAgIGR5bmFtb0RiVGFibGUudGFibGVOYW1lLFxuICAgICAgICAgICAgICAgICAgICAnR2V0JyxcbiAgICAgICAgICAgICAgICAgICAgJ1N5c3RlbUVycm9ycycsXG4gICAgICAgICAgICAgICAgICAgIGN3LlN0YXRpc3RpYy5TVU0sXG4gICAgICAgICAgICAgICAgICAgIGN3LlVuaXQuQ09VTlQsXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIE9wZXJhdGlvbjogJ0dldEl0ZW0nLFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICB0aGlzLmRkYk1ldHJpYyhcbiAgICAgICAgICAgICAgICAgICAgZHluYW1vRGJUYWJsZS50YWJsZU5hbWUsXG4gICAgICAgICAgICAgICAgICAgICdCYXRjaCBHZXQnLFxuICAgICAgICAgICAgICAgICAgICAnU3lzdGVtRXJyb3JzJyxcbiAgICAgICAgICAgICAgICAgICAgY3cuU3RhdGlzdGljLlNVTSxcbiAgICAgICAgICAgICAgICAgICAgY3cuVW5pdC5DT1VOVCxcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgT3BlcmF0aW9uOiAnQmF0Y2hHZXRJdGVtJyxcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgdGhpcy5kZGJNZXRyaWMoXG4gICAgICAgICAgICAgICAgICAgIGR5bmFtb0RiVGFibGUudGFibGVOYW1lLFxuICAgICAgICAgICAgICAgICAgICAnU2NhbicsXG4gICAgICAgICAgICAgICAgICAgICdTeXN0ZW1FcnJvcnMnLFxuICAgICAgICAgICAgICAgICAgICBjdy5TdGF0aXN0aWMuU1VNLFxuICAgICAgICAgICAgICAgICAgICBjdy5Vbml0LkNPVU5ULFxuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICBPcGVyYXRpb246ICdTY2FuJyxcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgdGhpcy5kZGJNZXRyaWMoXG4gICAgICAgICAgICAgICAgICAgIGR5bmFtb0RiVGFibGUudGFibGVOYW1lLFxuICAgICAgICAgICAgICAgICAgICAnUXVlcnknLFxuICAgICAgICAgICAgICAgICAgICAnU3lzdGVtRXJyb3JzJyxcbiAgICAgICAgICAgICAgICAgICAgY3cuU3RhdGlzdGljLlNVTSxcbiAgICAgICAgICAgICAgICAgICAgY3cuVW5pdC5DT1VOVCxcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgT3BlcmF0aW9uOiAnUXVlcnknLFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICB0aGlzLmRkYk1ldHJpYyhcbiAgICAgICAgICAgICAgICAgICAgZHluYW1vRGJUYWJsZS50YWJsZU5hbWUsXG4gICAgICAgICAgICAgICAgICAgICdQdXQnLFxuICAgICAgICAgICAgICAgICAgICAnU3lzdGVtRXJyb3JzJyxcbiAgICAgICAgICAgICAgICAgICAgY3cuU3RhdGlzdGljLlNVTSxcbiAgICAgICAgICAgICAgICAgICAgY3cuVW5pdC5DT1VOVCxcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgT3BlcmF0aW9uOiAnUHV0SXRlbScsXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgIHRoaXMuZGRiTWV0cmljKFxuICAgICAgICAgICAgICAgICAgICBkeW5hbW9EYlRhYmxlLnRhYmxlTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgJ0JhdGNoIFdyaXRlJyxcbiAgICAgICAgICAgICAgICAgICAgJ1N5c3RlbUVycm9ycycsXG4gICAgICAgICAgICAgICAgICAgIGN3LlN0YXRpc3RpYy5TVU0sXG4gICAgICAgICAgICAgICAgICAgIGN3LlVuaXQuQ09VTlQsXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIE9wZXJhdGlvbjogJ0JhdGNoV3JpdGVJdGVtJyxcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgdGhpcy5kZGJNZXRyaWMoXG4gICAgICAgICAgICAgICAgICAgIGR5bmFtb0RiVGFibGUudGFibGVOYW1lLFxuICAgICAgICAgICAgICAgICAgICAnVXBkYXRlJyxcbiAgICAgICAgICAgICAgICAgICAgJ1N5c3RlbUVycm9ycycsXG4gICAgICAgICAgICAgICAgICAgIGN3LlN0YXRpc3RpYy5TVU0sXG4gICAgICAgICAgICAgICAgICAgIGN3LlVuaXQuQ09VTlQsXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIE9wZXJhdGlvbjogJ1VwZGF0ZUl0ZW0nLFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICB0aGlzLmRkYk1ldHJpYyhcbiAgICAgICAgICAgICAgICAgICAgZHluYW1vRGJUYWJsZS50YWJsZU5hbWUsXG4gICAgICAgICAgICAgICAgICAgICdEZWxldGUnLFxuICAgICAgICAgICAgICAgICAgICAnU3lzdGVtRXJyb3JzJyxcbiAgICAgICAgICAgICAgICAgICAgY3cuU3RhdGlzdGljLlNVTSxcbiAgICAgICAgICAgICAgICAgICAgY3cuVW5pdC5DT1VOVCxcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgT3BlcmF0aW9uOiAnRGVsZXRlSXRlbScsXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgXSksXG4gICAgICAgICAgICB0aGlzLmRkYldpZGdldChgJHtwcmVmaXh9IC0gVGhyb3R0bGVkIFJlcXVlc3RzYCwgW1xuICAgICAgICAgICAgICAgIHRoaXMuZGRiTWV0cmljKFxuICAgICAgICAgICAgICAgICAgICBkeW5hbW9EYlRhYmxlLnRhYmxlTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgJ1Rocm90dGxlZCBSZXF1ZXN0cycsXG4gICAgICAgICAgICAgICAgICAgICdUaHJvdHRsZWRSZXF1ZXN0cycsXG4gICAgICAgICAgICAgICAgICAgIGN3LlN0YXRpc3RpYy5TVU0sXG4gICAgICAgICAgICAgICAgICAgIGN3LlVuaXQuQ09VTlRcbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgXSksXG4gICAgICAgIF07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkZGJNZXRyaWMoXG4gICAgICAgIHRhYmxlTmFtZTogc3RyaW5nLFxuICAgICAgICBsYWJlbDogc3RyaW5nLFxuICAgICAgICBtZXRyaWNOYW1lOiBzdHJpbmcsXG4gICAgICAgIHN0YXRpc3RpYzogY3cuU3RhdGlzdGljLFxuICAgICAgICB1bml0PzogY3cuVW5pdCxcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcbiAgICAgICAgZGltZW5zaW9ucz86IFJlY29yZDxzdHJpbmcsIGFueT5cbiAgICApOiBjdy5JTWV0cmljIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlR3JhcGhNZXRyaWMoe1xuICAgICAgICAgICAgbGFiZWwsXG4gICAgICAgICAgICBtZXRyaWNOYW1lLFxuICAgICAgICAgICAgc3RhdGlzdGljLFxuICAgICAgICAgICAgbmFtZXNwYWNlOiAnQVdTL0R5bmFtb0RCJyxcbiAgICAgICAgICAgIHVuaXQsXG4gICAgICAgICAgICBkaW1lbnNpb25zTWFwOiB7IC4uLmRpbWVuc2lvbnMsIFRhYmxlTmFtZTogdGFibGVOYW1lIH0sXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgZGRiV2lkZ2V0KHRpdGxlOiBzdHJpbmcsIG1ldHJpY3M6IGN3LklNZXRyaWNbXSk6IGN3LklXaWRnZXQge1xuICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGVHcmFwaFdpZGdldCh7IHRpdGxlLCBsZWZ0OiBtZXRyaWNzIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXBpR2F0ZXdheVdpZGdldChcbiAgICAgICAgdGl0bGU6IHN0cmluZyxcbiAgICAgICAgbGVmdE1ldHJpY3M6IGN3LklNZXRyaWNbXSxcbiAgICAgICAgcmlnaHRNZXRyaWNzPzogY3cuSU1ldHJpY1tdLFxuICAgICAgICBsZWZ0TGFiZWw/OiBzdHJpbmcsXG4gICAgICAgIHJpZ2h0TGFiZWw/OiBzdHJpbmdcbiAgICApOiBjdy5JV2lkZ2V0IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlR3JhcGhXaWRnZXQoe1xuICAgICAgICAgICAgdGl0bGUsXG4gICAgICAgICAgICBsZWZ0OiBsZWZ0TWV0cmljcyxcbiAgICAgICAgICAgIHJpZ2h0OiByaWdodE1ldHJpY3MsXG4gICAgICAgICAgICBsZWZ0WUF4aXM6IHsgbGFiZWw6IGxlZnRMYWJlbCB9LFxuICAgICAgICAgICAgcmlnaHRZQXhpczogeyBsYWJlbDogcmlnaHRMYWJlbCB9LFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFwaUdhdGV3YXlNZXRyaWMoXG4gICAgICAgIGFwaU5hbWU6IHN0cmluZyxcbiAgICAgICAgbGFiZWw6IHN0cmluZyxcbiAgICAgICAgbWV0cmljTmFtZTogc3RyaW5nLFxuICAgICAgICBzdGF0aXN0aWM6IGN3LlN0YXRpc3RpYyxcbiAgICAgICAgdW5pdDogY3cuVW5pdCxcbiAgICAgICAgbWV0aG9kOiBzdHJpbmcsXG4gICAgICAgIHJlc291cmNlOiBzdHJpbmcsXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gICAgICAgIGRpbWVuc2lvbnM/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+XG4gICAgKTogY3cuSU1ldHJpYyB7XG4gICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZUdyYXBoTWV0cmljKHtcbiAgICAgICAgICAgIGxhYmVsLFxuICAgICAgICAgICAgbWV0cmljTmFtZSxcbiAgICAgICAgICAgIHN0YXRpc3RpYyxcbiAgICAgICAgICAgIHVuaXQsXG4gICAgICAgICAgICBuYW1lc3BhY2U6ICdBV1MvQXBpR2F0ZXdheScsXG4gICAgICAgICAgICBkaW1lbnNpb25zTWFwOiB7XG4gICAgICAgICAgICAgICAgLi4uZGltZW5zaW9ucyxcbiAgICAgICAgICAgICAgICBBcGlOYW1lOiBhcGlOYW1lLFxuICAgICAgICAgICAgICAgIFN0YWdlOiAncHJvZCcsXG4gICAgICAgICAgICAgICAgTWV0aG9kOiBtZXRob2QsXG4gICAgICAgICAgICAgICAgUmVzb3VyY2U6IHJlc291cmNlLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjcmVhdGVHcmFwaFdpZGdldChwcm9wczogY3cuR3JhcGhXaWRnZXRQcm9wcyk6IGN3LkdyYXBoV2lkZ2V0IHtcbiAgICAgICAgcmV0dXJuIG5ldyBjdy5HcmFwaFdpZGdldCh7IGhlaWdodDogNiwgd2lkdGg6IDYsIGxpdmVEYXRhOiB0cnVlLCAuLi5wcm9wcyB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNyZWF0ZUdyYXBoTWV0cmljKHByb3BzOiBjdy5NZXRyaWNQcm9wcyk6IGN3LklNZXRyaWMge1xuICAgICAgICByZXR1cm4gbmV3IGN3Lk1ldHJpYyhwcm9wcyk7XG4gICAgfVxufVxuIl19